<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doodle World Tools</title>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #ffffff;
            --main-bg: #1e1e1e;
            --card-bg: #2a2a2a;
            --card-border: none;
            --button-bg: #444;
            --button-hover: #555;
            --input-bg: #333;
            --input-border: #444;
            --shadow: rgba(0, 0, 0, 0.3);
            --active-team: #4CAF50;
            --header-color: #ffffff;
            --section-border: #444;
            --expand-bg: #333;
            --nav-bg: #1a1a1a;
            --nav-active: #333;
            --nav-box-bg: #2a2a2a;
            --nav-box-hover: #333;
            
            --mythic-color: #b19cd9;
            --fire-color: #ff8c00;
            --water-color: #1e90ff;
            --plant-color: #4CAF50;
            --spark-color: #FFEB3B;
            --beast-color: #8B4513;
            --air-color: #87CEFA;
            --insect-color: #6CC417;
            --earth-color: #CD853F;
            --mind-color: #FFB6C1;
            --melee-color: #ff6b6b;
            --food-color: #f5deb3;
            --light-color: #fffacd;
            --crystal-color: #00ced1;
            --metal-color: #a9a9a9;
            --spirit-color: #9400d3;
            --ice-color: #e0ffff;
            --dark-color: #000000;
            --poison-color: #da70d6;
            --basic-color: #cccccc;
        }

        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            color: var(--text-color);
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .nav-container {
            background-color: var(--nav-bg);
            padding: 10px 0;
            box-shadow: 0 2px 10px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            margin-bottom: 20px;
        }

        .nav-menu {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            list-style: none;
            padding: 0 20px;
            gap: 10px;
        }

        .nav-item {
            flex: 1;
        }

        .nav-button {
            width: 100%;
            background: var(--nav-box-bg);
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: none;
            text-align: center;
            border-radius: 8px;
        }

        .nav-button:hover {
            background-color: var(--nav-box-hover);
        }

        .nav-button.active {
            background-color: var(--nav-active);
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: var(--main-bg);
            border-radius: 0;
            padding: 20px;
            box-shadow: 0 4px 12px var(--shadow);
            min-height: calc(100vh - 100px);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--header-color);
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }

        .team-management {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .team-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
        }

        .team-selector select {
            flex: 1;
            padding: 10px;
            border-radius: 0;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            min-width: 150px;
        }

        .team-actions {
            display: flex;
            gap: 10px;
        }

        .team-action-btn {
            background-color: var(--button-bg);
            border: none;
            border-radius: 0;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }

        .team-name-input {
            padding: 12px;
            border-radius: 0;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            font-size: 16px;
            flex: 1;
            min-width: 200px;
        }

        .doodle-creation {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .doodle-selector {
            display: flex;
            gap: 10px;
            flex: 1;
            position: relative;
        }

        .custom-dropdown {
            position: relative;
            flex: 1;
        }

        .dropdown-header {
            padding: 10px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 44px;
            font-size: 16px;
            line-height: 24px;
        }

        .dropdown-header span:first-child {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-top: none;
            z-index: 1000;
            display: none;
        }

        .dropdown-list.active {
            display: block;
        }

        .dropdown-search {
            width: 100%;
            padding: 8px;
            border: none;
            border-bottom: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .dropdown-options {
            max-height: 250px;
            overflow-y: auto;
        }

        .dropdown-option {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--section-border);
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 36px;
        }

        .dropdown-option:hover {
            background-color: var(--button-bg);
        }

        .dropdown-option.selected {
            background-color: var(--button-hover);
        }

        .dropdown-option .type-icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .add-doodle-btn {
            background-color: var(--button-bg);
            border: none;
            border-radius: 0;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }

        .attunement-toggle {
            margin: 10px 0;
            display: flex;
            justify-content: center;
        }

        .attunement-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
        }

        .attunement-label input[type="checkbox"] {
            margin: 0;
        }

        .attunement-text {
            font-weight: bold;
        }

        .team-display {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .doodle-card {
            background-color: var(--card-bg);
            border: none;
            border-radius: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
            position: relative;
            cursor: move;
        }

        .doodle-card.dragging {
            opacity: 0.5;
        }

        .doodle-card.drag-over {
            border: 2px dashed var(--button-hover);
        }

        .doodle-card.attuned {
            border-left: 4px solid var(--mythic-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .doodle-sprite-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .doodle-sprite {
            width: 100px;
            height: 100px;
            background-color: var(--input-border);
            border-radius: 0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .doodle-info {
            flex: 1;
        }

        .doodle-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .attunement-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--mythic-color);
            border-radius: 50%;
        }

        .type-badges {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .type-badge {
            padding: 3px 8px;
            border-radius: 0;
            font-size: 12px;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Dark font for specific types */
        .type-badge.food,
        .type-badge.spark,
        .type-badge.ice,
        .type-badge.light {
            color: #000000;
            font-weight: bold;
        }

        .type-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .card-buttons {
            display: flex;
            gap: 8px;
        }

        .card-btn {
            background: var(--button-bg);
            border: none;
            border-radius: 0;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .card-btn:hover {
            background: var(--button-hover);
        }

        .attune-btn {
            background-color: var(--mythic-color) !important;
            font-weight: bold;
        }

        .attune-btn:hover {
            background-color: #c9b1f0 !important;
        }

        .expand-section {
            display: none;
            margin-top: 15px;
            background-color: var(--expand-bg);
            padding: 15px;
            border-radius: 0;
            box-shadow: 0 2px 6px var(--shadow);
            font-size: 14px;
        }

        .expand-section.active {
            display: block;
        }

        .section-title {
            font-size: 16px;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--section-border);
        }

        .moves-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stats-container, .equipment-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .equipment-container {
            grid-template-columns: 1fr;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            background-color: var(--button-bg);
            border: none;
            border-radius: 0;
            padding: 10px 16px;
            cursor: pointer;
            font-weight: bold;
        }

        .footer {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--section-border);
            flex-wrap: wrap;
        }

        .credits, .update-info {
            font-size: 14px;
        }

        .calculator-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .calculator-box {
            border: 2px solid var(--section-border);
            padding: 20px;
            background: var(--card-bg);
            text-align: left;
            border-radius: 0;
            position: relative;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .calculator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--section-border);
        }

        .remove-calc {
            background: var(--button-bg);
            color: var(--text-color);
            border: none;
            border-radius: 0;
            width: 32px;
            height: 32px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-calc:hover {
            background: #ff4444;
        }

        .type-select-container {
            margin-bottom: 15px;
        }

        .type-select {
            padding: 12px;
            width: 100%;
            border: 1px solid var(--input-border);
            border-radius: 0;
            background-color: var(--input-bg);
            color: var(--text-color);
            margin-bottom: 12px;
            box-shadow: 0 2px 4px var(--shadow);
            font-size: 14px;
        }

        .result-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-color);
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .result-list {
            min-height: 40px;
            padding: 15px;
            background: var(--input-bg);
            border-radius: 0;
            border: 1px solid var(--input-border);
            margin-bottom: 15px;
            color: var(--text-color);
            box-shadow: inset 0 2px 4px var(--shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .calc-type-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px 6px 40px;
            border-radius: 0;
            color: white;
            font-size: 13px;
            font-weight: bold;
            white-space: nowrap;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px var(--shadow);
        }

        /* Dark font for specific types in defensive calculator */
        .calc-type-badge.food,
        .calc-type-badge.spark,
        .calc-type-badge.ice,
        .calc-type-badge.light {
            color: #000000;
            font-weight: bold;
        }

        .calc-type-badge .type-icon {
            position: absolute;
            left: 12px;
            width: 20px;
            height: 20px;
        }

        .team-summary {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 0;
            border: 1px solid var(--section-border);
            margin-top: 30px;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .summary-box {
            padding: 20px;
            background: var(--input-bg);
            border-radius: 0;
            border: 1px solid var(--section-border);
            min-height: 140px;
            box-shadow: 0 4px 8px var(--shadow);
            transition: all 0.3s ease;
        }

        .summary-title {
            font-weight: bold;
            margin-bottom: 12px;
            color: var(--text-color);
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .none {
            color: #666;
            font-style: italic;
        }

        .add-doodle-calc {
            background: var(--button-bg);
            color: var(--text-color);
            border: none;
            padding: 14px 28px;
            border-radius: 0;
            cursor: pointer;
            margin: 20px 0;
            box-shadow: 0 4px 8px var(--shadow);
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 16px;
        }

        .add-doodle-calc:hover {
            background: var(--button-hover);
        }

        .save-load-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .save-btn, .load-btn {
            background-color: var(--button-bg);
            color: var(--text-color);
            border: none;
            padding: 10px 20px;
            border-radius: 0;
            cursor: pointer;
            box-shadow: 0 2px 4px var(--shadow);
            transition: all 0.3s ease;
        }

        .save-btn:hover, .load-btn:hover {
            background-color: var(--button-hover);
        }

        .offensive-calculator {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .type-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .offensive-type-select {
            padding: 12px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            border-radius: 0;
            font-size: 16px;
            width: 100%;
        }

        .calculate-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .calculate-btn, .reset-btn {
            background-color: var(--button-bg);
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 0;
            transition: background-color 0.3s;
            width: 100%;
            max-width: 300px;
        }

        .calculate-btn:hover {
            background-color: var(--button-hover);
        }

        .reset-btn {
            background-color: #555;
        }

        .reset-btn:hover {
            background-color: #666;
        }

        .offensive-results-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .offensive-result-category {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 0;
            box-shadow: 0 4px 12px var(--shadow);
            min-height: 200px;
        }

        .offensive-result-category h3 {
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--section-border);
            font-size: 18px;
            text-align: center;
        }

        .offensive-result-list {
            min-height: 150px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .offensive-doodle-result {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background-color: var(--input-bg);
            border-radius: 0;
            border: 1px solid var(--input-border);
        }

        .offensive-doodle-result .doodle-sprite {
            width: 50px;
            height: 50px;
            margin: 0;
        }

        .offensive-doodle-result .doodle-info {
            flex: 1;
        }

        .offensive-doodle-result .doodle-name {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .offensive-doodle-result .type-badges {
            gap: 3px;
        }

        .offensive-doodle-result .type-badge {
            font-size: 10px;
            padding: 2px 6px;
        }

        .offensive-doodle-result .type-icon {
            width: 16px;
            height: 16px;
        }

        .offensive-traits-toggle {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }

        .traits-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
        }

        .traits-label input[type="checkbox"] {
            margin: 0;
        }

        .traits-text {
            font-weight: bold;
        }

        .move-group-header {
            background-color: var(--button-bg);
            padding: 5px 10px;
            font-weight: bold;
            font-size: 12px;
            border-bottom: 1px solid var(--section-border);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .dropdown-option.move-option {
            padding-left: 30px;
            position: relative;
        }

        .dropdown-option.move-option .type-icon {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
        }

        .dropdown-header .type-icon {
            margin-right: 8px;
            width: 20px;
            height: 20px;
        }

        .matchup-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .matchup-doodles {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .matchup-doodle-select {
            position: relative;
            width: 100%;
        }

        .matchup-dropdown-header {
            padding: 12px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 46px;
        }

        .matchup-dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-top: none;
            z-index: 1000;
            display: none;
        }

        .matchup-dropdown-list.active {
            display: block;
        }

        .matchup-dropdown-search {
            width: 100%;
            padding: 8px;
            border: none;
            border-bottom: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .matchup-options {
            max-height: 250px;
            overflow-y: auto;
        }

        .matchup-option {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--section-border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .matchup-option:hover {
            background-color: var(--button-bg);
        }

        .matchup-option.selected {
            background-color: var(--button-hover);
        }

        .mini-sprite {
            width: 40px;
            height: 40px;
            background-color: var(--input-border);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            flex-shrink: 0;
        }

        .matchup-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .matchup-btn {
            background-color: var(--button-bg);
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 0;
            transition: background-color 0.3s;
            min-width: 200px;
        }

        .matchup-btn:hover {
            background-color: var(--button-hover);
        }

        .matchup-results-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .matchup-result-category {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 0;
            box-shadow: 0 4px 12px var(--shadow);
            min-height: 400px;
        }

        .matchup-result-category h3 {
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--section-border);
            font-size: 18px;
            text-align: center;
        }

        .matchup-result-list {
            min-height: 350px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            max-height: 350px;
        }

        .matchup-result-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: var(--input-bg);
            border-radius: 0;
            border: 1px solid var(--input-border);
        }

        .matchup-result-item .doodle-sprite {
            width: 60px;
            height: 60px;
            margin: 0;
        }

        .matchup-result-item .doodle-info {
            flex: 1;
        }

        .matchup-result-item .doodle-name {
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .matchup-result-item .type-badges {
            gap: 5px;
        }

        .matchup-result-item .type-badge {
            font-size: 11px;
            padding: 3px 8px;
        }

        .matchup-result-item .type-icon {
            width: 20px;
            height: 20px;
        }

        .matchup-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--section-border);
            font-size: 14px;
            color: var(--text-color);
        }

        .matchup-stat {
            text-align: center;
            flex: 1;
        }

        .matchup-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--header-color);
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .team-management, .doodle-creation {
                flex-direction: column;
            }
            
            .team-selector, .doodle-selector {
                flex-direction: column;
            }
            
            .doodle-sprite-container {
                flex-direction: column;
                text-align: center;
            }
            
            .controls {
                flex-wrap: wrap;
            }
            
            .footer {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .moves-container, .stats-container, .equipment-container {
                grid-template-columns: 1fr;
            }
            
            .calculator-container {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .nav-menu {
                flex-direction: column;
            }
            
            .type-selection {
                grid-template-columns: 1fr;
            }
            
            .offensive-results-container {
                grid-template-columns: 1fr;
            }
            
            .save-load-container {
                flex-direction: column;
                align-items: center;
            }
            
            .calculate-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .matchup-doodles {
                grid-template-columns: 1fr 1fr;
            }
            
            .matchup-results-container {
                grid-template-columns: 1fr;
            }
            
            .matchup-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .matchup-btn {
                width: 100%;
                max-width: 300px;
            }
        }

        @media (max-width: 600px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .matchup-doodles {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="nav-container">
        <ul class="nav-menu">
            <li class="nav-item">
                <button class="nav-button active" data-page="teambuilder">Teambuilder</button>
            </li>
            <li class="nav-item">
                <button class="nav-button" data-page="defensive">Defensive Calculator</button>
            </li>
            <li class="nav-item">
                <button class="nav-button" data-page="offensive">Offensive Calculator</button>
            </li>
            <li class="nav-item">
                <button class="nav-button" data-page="matchup">Matchup Calculator</button>
            </li>
        </ul>
    </div>

    <div class="main-container">
        <!-- Teambuilder Page -->
        <div class="page active" id="teambuilder">
            <div class="header">
                <h1>Doodle World Teambuilder</h1>
            </div>
            
            <div class="team-management">
                <div class="team-selector">
                    <select id="team-select">
                        <option value="">Select a Team</option>
                    </select>
                    <div class="team-actions">
                        <button class="team-action-btn" id="add-team">Add Team</button>
                        <button class="team-action-btn" id="delete-team">Delete Team</button>
                    </div>
                </div>
                <input type="text" class="team-name-input" id="team-name" placeholder="Enter team name...">
            </div>
            
            <div class="doodle-creation">
                <div class="custom-dropdown" id="doodle-dropdown">
                    <div class="dropdown-header" id="doodle-header">
                        <span>Select a Doodle</span>
                        <span>â–¼</span>
                    </div>
                    <div class="dropdown-list" id="doodle-list">
                        <input type="text" class="dropdown-search" id="doodle-search" placeholder="Search doodles...">
                        <div class="dropdown-options" id="doodle-options"></div>
                    </div>
                </div>
                <button class="add-doodle-btn" id="add-doodle">Add Doodle</button>
            </div>
            
            <!-- Attunement Toggle -->
            <div class="attunement-toggle">
                <label class="attunement-label">
                    <input type="checkbox" id="auto-attune" checked>
                    <span class="attunement-text">Auto-attune signature items & traits</span>
                </label>
            </div>
            
            <div class="team-display" id="team-display">
            </div>
            
            <div class="controls">
                <button class="control-btn" id="copy-code">Copy Team Code</button>
                <button class="control-btn" id="import-code">Import Team Code</button>
                <button class="control-btn" id="import-text">Import from Text</button>
            </div>
            
            <div class="footer">
                <div class="credits">Created by Bwiffs</div>
                <div class="update-info">Updated: 1/20/2026</div>
            </div>
        </div>

        <!-- Defensive Calculator Page -->
        <div class="page" id="defensive">
            <div class="header">
                <h1>Defensive Type Calculator</h1>
            </div>

            <div class="save-load-container">
                <button class="save-btn" id="save-defensive">Save Defensive Team</button>
                <button class="load-btn" id="load-defensive">Load Defensive Team</button>
                <button class="load-btn" id="load-from-teambuilder">Load from Teambuilder</button>
            </div>

            <div class="calculator-container" id="defensive-container"></div>
            
            <button class="add-doodle-calc" id="add-defensive">+ Add Doodle</button>

            <div class="team-summary">
                <h2>Team Summary</h2>
                <div class="summary-grid">
                    <div class="summary-box">
                        <div class="summary-title">Team Weaknesses</div>
                        <div id="team-weaknesses" class="result-list">None</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-title">Team Resistances</div>
                        <div id="team-resistances" class="result-list">None</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-title">Team Immunities</div>
                        <div id="team-immunities" class="result-list">None</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-title">No Resistances</div>
                        <div id="team-no-resistances" class="result-list">None</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Offensive Calculator Page -->
        <div class="page" id="offensive">
            <div class="header">
                <h1>Offensive Type Coverage Calculator</h1>
            </div>

            <div class="offensive-calculator">
                <div class="type-selection">
                    <select class="offensive-type-select" id="type-1">
                        <option value="">Select Type 1</option>
                    </select>
                    <select class="offensive-type-select" id="type-2">
                        <option value="">Select Type 2</option>
                    </select>
                    <select class="offensive-type-select" id="type-3">
                        <option value="">Select Type 3</option>
                    </select>
                    <select class="offensive-type-select" id="type-4">
                        <option value="">Select Type 4</option>
                    </select>
                </div>

                <div class="offensive-traits-toggle">
                    <label class="traits-label">
                        <input type="checkbox" id="include-traits">
                        <span class="traits-text">Include Traits</span>
                    </label>
                </div>

                <div class="calculate-buttons">
                    <button class="calculate-btn" id="calculate-coverage">Calculate Coverage</button>
                    <button class="reset-btn" id="reset-coverage">Reset</button>
                </div>

                <div class="offensive-results-container">
                    <div class="offensive-result-category">
                        <h3>Super Effective</h3>
                        <div id="super-effective" class="offensive-result-list">
                            <span class="none">None</span>
                        </div>
                    </div>
                    <div class="offensive-result-category">
                        <h3>Normal Effectiveness</h3>
                        <div id="normal-effective" class="offensive-result-list">
                            <span class="none">None</span>
                        </div>
                    </div>
                    <div class="offensive-result-category">
                        <h3>Not Very Effective</h3>
                        <div id="not-very-effective" class="offensive-result-list">
                            <span class="none">None</span>
                        </div>
                    </div>
                    <div class="offensive-result-category">
                        <h3>No Effect</h3>
                        <div id="no-effect" class="offensive-result-list">
                            <span class="none">None</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer">
                <div class="credits">Created by Bwiffs</div>
                <div class="update-info">Updated: 1/20/2026</div>
            </div>
        </div>

        <!-- Matchup Calculator Page -->
        <div class="page" id="matchup">
            <div class="header">
                <h1>Matchup Calculator</h1>
            </div>

            <div class="matchup-container">
                <h3 style="text-align: center; margin-bottom: 20px;">Select up to 4 doodles to find coverage against them</h3>
                
                <div class="matchup-doodles" id="matchup-doodles">
                    <!-- Doodle selectors will be added here by JavaScript -->
                </div>

                <div class="matchup-controls">
                    <button class="matchup-btn" id="calculate-matchup">Find Coverage</button>
                    <button class="matchup-btn" id="clear-matchup">Clear All</button>
                </div>

                <div class="matchup-stats">
                    <div class="matchup-stat">
                        <div>Doodles Found</div>
                        <div class="matchup-stat-value" id="found-count">0</div>
                    </div>
                    <div class="matchup-stat">
                        <div>Best Coverage</div>
                        <div class="matchup-stat-value" id="best-coverage">0 types</div>
                    </div>
                </div>

                <div class="matchup-results-container">
                    <div class="matchup-result-category">
                        <h3>Best Coverage Doodles</h3>
                        <div id="best-coverage-list" class="matchup-result-list">
                            <span class="none">Select doodles</span>
                        </div>
                    </div>
                    <div class="matchup-result-category">
                        <h3>All Coverage Doodles</h3>
                        <div id="all-coverage-list" class="matchup-result-list">
                            <span class="none">Select doodles</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer">
                <div class="credits">Created by Bwiffs</div>
                <div class="update-info">Updated: 1/03/2026</div>
            </div>
        </div>
    </div>

    <script>
        // DEFENSIVE TYPE CHART
        const defensiveTypeChart = {
            "basic": {
                "basic": 1, "fire": 1, "water": 1, "plant": 1, "spark": 1, 
                "beast": 1, "air": 1, "insect": 1, "earth": 1, "mind": 1, 
                "melee": 2, "food": 1, "light": 1, "crystal": 1, "metal": 1, 
                "spirit": 0, "ice": 1, "dark": 1, "poison": 1, "mythic": 1
            },
            "fire": {
                "basic": 1, "fire": 0.5, "water": 2, "plant": 0.5, "spark": 1, 
                "beast": 0.5, "air": 1, "insect": 0.5, "earth": 2, "mind": 1, 
                "melee": 1, "food": 0.5, "light": 1, "crystal": 1, "metal": 0.5, 
                "spirit": 1, "ice": 2, "dark": 1, "poison": 1, "mythic": 1
            },
            "water": {
                "basic": 1, "fire": 0.5, "water": 0.5, "plant": 2, "spark": 2, 
                "beast": 1, "air": 1, "insect": 1, "earth": 1, "mind": 1, 
                "melee": 1, "food": 1, "light": 1, "crystal": 0.5, "metal": 0.5, 
                "spirit": 1, "ice": 0.5, "dark": 1, "poison": 2, "mythic": 1
            },
            "plant": {
                "basic": 1, "fire": 2, "water": 0.5, "plant": 0.5, "spark": 0.5, 
                "beast": 1, "air": 2, "insect": 2, "earth": 0.5, "mind": 1, 
                "melee": 1, "food": 0.5, "light": 0.5, "crystal": 1, "metal": 1, 
                "spirit": 1, "ice": 2, "dark": 1, "poison": 2, "mythic": 1
            },
            "spark": {
                "basic": 1, "fire": 1, "water": 1, "plant": 1, "spark": 0.5, 
                "beast": 0.5, "air": 0.5, "insect": 1, "earth": 2, "mind": 1, 
                "melee": 1, "food": 1, "light": 1, "crystal": 2, "metal": 0.5, 
                "spirit": 1, "ice": 1, "dark": 1, "poison": 1, "mythic": 1
            },
            "beast": {
                "basic": 1, "fire": 2, "water": 1, "plant": 1, "spark": 2, 
                "beast": 2, "air": 1, "insect": 0.5, "earth": 1, "mind": 2, 
                "melee": 1, "food": 0.5, "light": 1, "crystal": 1, "metal": 1, 
                "spirit": 1, "ice": 1, "dark": 0.5, "poison": 1, "mythic": 1
            },
            "air": {
                "basic": 1, "fire": 1, "water": 1, "plant": 0.5, "spark": 2, 
                "beast": 1, "air": 1, "insect": 0.5, "earth": 0, "mind": 1, 
                "melee": 0.5, "food": 1, "light": 1, "crystal": 1, "metal": 1, 
                "spirit": 1, "ice": 2, "dark": 1, "poison": 2, "mythic": 1
            },
            "insect": {
                "basic": 1, "fire": 2, "water": 1, "plant": 0.5, "spark": 2, 
                "beast": 2, "air": 2, "insect": 1, "earth": 0.5, "mind": 1, 
                "melee": 0.5, "food": 1, "light": 1, "crystal": 1, "metal": 1, 
                "spirit": 1, "ice": 1, "dark": 0.5, "poison": 1, "mythic": 1
            },
            "earth": {
                "basic": 1, "fire": 0.5, "water": 2, "plant": 2, "spark": 0, 
                "beast": 1, "air": 1, "insect": 1, "earth": 1, "mind": 1, 
                "melee": 1, "food": 1, "light": 1, "crystal": 0.5, "metal": 1, 
                "spirit": 1, "ice": 1, "dark": 1, "poison": 0.5, "mythic": 1
            },
            "mind": {
                "basic": 1, "fire": 1, "water": 1, "plant": 1, "spark": 1, 
                "beast": 1, "air": 1, "insect": 2, "earth": 1, "mind": 0.5, 
                "melee": 0.5, "food": 2, "light": 1, "crystal": 1, "metal": 1, 
                "spirit": 2, "ice": 1, "dark": 2, "poison": 1, "mythic": 1
            },
            "melee": {
                "basic": 1, "fire": 1, "water": 1, "plant": 1, "spark": 1, 
                "beast": 0.5, "air": 2, "insect": 0.5, "earth": 1, "mind": 2, 
                "melee": 1, "food": 2, "light": 1, "crystal": 1, "metal": 1, 
                "spirit": 1, "ice": 0.5, "dark": 1, "poison": 1, "mythic": 1
            },
            "food": {
                "basic": 1, "fire": 2, "water": 2, "plant": 1, "spark": 0.5, 
                "beast": 2, "air": 1, "insect": 2, "earth": 1, "mind": 1, 
                "melee": 1, "food": 1, "light": 0.5, "crystal": 1, "metal": 1, 
                "spirit": 1, "ice": 1, "dark": 0.5, "poison": 1, "mythic": 1
            },
            "light": {
                "basic": 1, "fire": 0.5, "water": 1, "plant": 2, "spark": 1, 
                "beast": 1, "air": 1, "insect": 1, "earth": 1, "mind": 1, 
                "melee": 1, "food": 1, "light": 0.5, "crystal": 1, "metal": 1, 
                "spirit": 0, "ice": 1, "dark": 2, "poison": 1, "mythic": 1
            },
            "crystal": {
                "basic": 1, "fire": 0.5, "water": 1, "plant": 1, "spark": 0.5, 
                "beast": 1, "air": 1, "insect": 1, "earth": 2, "mind": 2, 
                "melee": 2, "food": 1, "light": 0.5, "crystal": 1, "metal": 2, 
                "spirit": 0.5, "ice": 1, "dark": 1, "poison": 0, "mythic": 1
            },
            "metal": {
                "basic": 0.5, "fire": 2, "water": 1, "plant": 0.5, "spark": 1, 
                "beast": 0.5, "air": 0.5, "insect": 0.5, "earth": 2, "mind": 0.5, 
                "melee": 2, "food": 1, "light": 1, "crystal": 1, "metal": 0.5, 
                "spirit": 1, "ice": 0.5, "dark": 1, "poison": 0, "mythic": 1
            },
            "spirit": {
                "basic": 0, "fire": 1, "water": 1, "plant": 1, "spark": 1, 
                "beast": 1, "air": 1, "insect": 1, "earth": 1, "mind": 0.5, 
                "melee": 0, "food": 0.5, "light": 2, "crystal": 2, "metal": 1, 
                "spirit": 2, "ice": 1, "dark": 2, "poison": 0.5, "mythic": 1
            },
            "ice": {
                "basic": 1, "fire": 2, "water": 1, "plant": 1, "spark": 1, 
                "beast": 1, "air": 1, "insect": 1, "earth": 1, "mind": 1, 
                "melee": 2, "food": 1, "light": 1, "crystal": 0.5, "metal": 2, 
                "spirit": 1, "ice": 0.5, "dark": 1, "poison": 1, "mythic": 1
            },
            "dark": {
                "basic": 1, "fire": 1, "water": 1, "plant": 1, "spark": 1, 
                "beast": 2, "air": 1, "insect": 2, "earth": 1, "mind": 0, 
                "melee": 1, "food": 1, "light": 2, "crystal": 1, "metal": 1, 
                "spirit": 0.5, "ice": 1, "dark": 0.5, "poison": 1, "mythic": 1
            },
            "poison": {
                "basic": 1, "fire": 1, "water": 0.5, "plant": 1, "spark": 1, 
                "beast": 1, "air": 0.5, "insect": 0.5, "earth": 2, "mind": 2, 
                "melee": 0.5, "food": 1, "light": 1, "crystal": 1, "metal": 1, 
                "spirit": 1, "ice": 1, "dark": 1, "poison": 0.5, "mythic": 1
            },
            "mythic": {
                "basic": 0.5, "fire": 0.5, "water": 0.5, "plant": 0.5, "spark": 0.5, 
                "beast": 0.5, "air": 1, "insect": 1, "earth": 1, "mind": 1, 
                "melee": 1, "food": 1, "light": 2, "crystal": 2, "metal": 1, 
                "spirit": 1, "ice": 1, "dark": 1, "poison": 1, "mythic": 2
            }
        };

        // OFFENSIVE TYPE CHART
        const offensiveTypeChart = {
            "basic": {
                "basic": 1, "fire": 1, "water": 1, "plant": 1, "spark": 1, 
                "beast": 1, "air": 1, "insect": 1, "earth": 1, "mind": 1, 
                "melee": 1, "food": 1, "light": 1, "crystal": 1, "metal": 0.5, 
                "spirit": 0, "ice": 1, "dark": 1, "poison": 1, "mythic": 0.5
            },
            "fire": {
                "basic": 1, "fire": 0.5, "water": 0.5, "plant": 2, "spark": 1, 
                "beast": 2, "air": 1, "insect": 2, "earth": 0.5, "mind": 1, 
                "melee": 1, "food": 2, "light": 0.5, "crystal": 0.5, "metal": 2, 
                "spirit": 1, "ice": 2, "dark": 1, "poison": 1, "mythic": 0.5
            },
            "water": {
                "basic": 1, "fire": 2, "water": 0.5, "plant": 0.5, "spark": 1, 
                "beast": 1, "air": 1, "insect": 1, "earth": 2, "mind": 1, 
                "melee": 1, "food": 2, "light": 1, "crystal": 1, "metal": 1, 
                "spirit": 1, "ice": 1, "dark": 1, "poison": 0.5, "mythic": 0.5
            },
            "plant": {
                "basic": 1, "fire": 0.5, "water": 2, "plant": 0.5, "spark": 1, 
                "beast": 1, "air": 0.5, "insect": 0.5, "earth": 2, "mind": 1, 
                "melee": 1, "food": 2, "light": 2, "crystal": 1, "metal": 0.5, 
                "spirit": 1, "ice": 1, "dark": 1, "poison": 1, "mythic": 0.5
            },
            "spark": {
                "basic": 1, "fire": 1, "water": 2, "plant": 0.5, "spark": 0.5, 
                "beast": 2, "air": 2, "insect": 2, "earth": 0, "mind": 1, 
                "melee": 1, "food": 0.5, "light": 1, "crystal": 0.5, "metal": 1, 
                "spirit": 1, "ice": 1, "dark": 1, "poison": 1, "mythic": 0.5
            },
            "beast": {
                "basic": 1, "fire": 0.5, "water": 1, "plant": 1, "spark": 0.5, 
                "beast": 2, "air": 1, "insect": 2, "earth": 1, "mind": 1, 
                "melee": 0.5, "food": 2, "light": 1, "crystal": 1, "metal": 0.5, 
                "spirit": 1, "ice": 1, "dark": 2, "poison": 1, "mythic": 0.5
            },
            "air": {
                "basic": 1, "fire": 1, "water": 1, "plant": 2, "spark": 0.5, 
                "beast": 1, "air": 1, "insect": 2, "earth": 1, "mind": 1, 
                "melee": 2, "food": 1, "light": 1, "crystal": 1, "metal": 0.5, 
                "spirit": 1, "ice": 1, "dark": 1, "poison": 0.5, "mythic": 1
            },
            "insect": {
                "basic": 1, "fire": 0.5, "water": 1, "plant": 2, "spark": 1, 
                "beast": 0.5, "air": 0.5, "insect": 1, "earth": 1, "mind": 2, 
                "melee": 0.5, "food": 2, "light": 1, "crystal": 1, "metal": 0.5, 
                "spirit": 1, "ice": 1, "dark": 2, "poison": 0.5, "mythic": 1
            },
            "earth": {
                "basic": 1, "fire": 2, "water": 1, "plant": 0.5, "spark": 2, 
                "beast": 1, "air": 0, "insect": 0.5, "earth": 1, "mind": 1, 
                "melee": 1, "food": 1, "light": 1, "crystal": 2, "metal": 2, 
                "spirit": 1, "ice": 2, "dark": 1, "poison": 2, "mythic": 1
            },
            "mind": {
                "basic": 1, "fire": 1, "water": 1, "plant": 1, "spark": 1, 
                "beast": 2, "air": 1, "insect": 1, "earth": 1, "mind": 0.5, 
                "melee": 2, "food": 1, "light": 1, "crystal": 2, "metal": 0.5, 
                "spirit": 0.5, "ice": 1, "dark": 0, "poison": 2, "mythic": 1
            },
            "melee": {
                "basic": 2, "fire": 1, "water": 1, "plant": 1, "spark": 1, 
                "beast": 1, "air": 0.5, "insect": 0.5, "earth": 1, "mind": 0.5, 
                "melee": 1, "food": 1, "light": 1, "crystal": 2, "metal": 2, 
                "spirit": 0, "ice": 2, "dark": 1, "poison": 0.5, "mythic": 1
            },
            "food": {
                "basic": 1, "fire": 0.5, "water": 1, "plant": 0.5, "spark": 1, 
                "beast": 0.5, "air": 1, "insect": 1, "earth": 1, "mind": 2, 
                "melee": 2, "food": 1, "light": 1, "crystal": 1, "metal": 1, 
                "spirit": 0.5, "ice": 1, "dark": 1, "poison": 1, "mythic": 1
            },
            "light": {
                "basic": 1, "fire": 1, "water": 1, "plant": 0.5, "spark": 1, 
                "beast": 1, "air": 1, "insect": 1, "earth": 1, "mind": 1, 
                "melee": 1, "food": 0.5, "light": 0.5, "crystal": 0.5, "metal": 1, 
                "spirit": 2, "ice": 1, "dark": 2, "poison": 1, "mythic": 2
            },
            "crystal": {
                "basic": 1, "fire": 1, "water": 0.5, "plant": 1, "spark": 2, 
                "beast": 1, "air": 1, "insect": 1, "earth": 0.5, "mind": 1, 
                "melee": 1, "food": 1, "light": 1, "crystal": 1, "metal": 1, 
                "spirit": 2, "ice": 0.5, "dark": 1, "poison": 1, "mythic": 2
            },
            "metal": {
                "basic": 1, "fire": 0.5, "water": 0.5, "plant": 1, "spark": 0.5, 
                "beast": 1, "air": 1, "insect": 1, "earth": 1, "mind": 1, 
                "melee": 1, "food": 1, "light": 1, "crystal": 2, "metal": 0.5, 
                "spirit": 1, "ice": 2, "dark": 1, "poison": 1, "mythic": 1
            },
            "spirit": {
                "basic": 0, "fire": 1, "water": 1, "plant": 1, "spark": 1, 
                "beast": 1, "air": 1, "insect": 1, "earth": 1, "mind": 2, 
                "melee": 1, "food": 1, "light": 0, "crystal": 0.5, "metal": 1, 
                "spirit": 2, "ice": 1, "dark": 0.5, "poison": 1, "mythic": 1
            },
            "ice": {
                "basic": 1, "fire": 2, "water": 0.5, "plant": 2, "spark": 1, 
                "beast": 1, "air": 2, "insect": 1, "earth": 2, "mind": 1, 
                "melee": 0.5, "food": 1, "light": 1, "crystal": 1, "metal": 0.5, 
                "spirit": 1, "ice": 0.5, "dark": 1, "poison": 1, "mythic": 1
            },
            "dark": {
                "basic": 1, "fire": 1, "water": 1, "plant": 1, "spark": 1, 
                "beast": 0.5, "air": 1, "insect": 0.5, "earth": 1, "mind": 2, 
                "melee": 1, "food": 0.5, "light": 2, "crystal": 1, "metal": 1, 
                "spirit": 2, "ice": 1, "dark": 0.5, "poison": 1, "mythic": 1
            },
            "poison": {
                "basic": 1, "fire": 1, "water": 2, "plant": 2, "spark": 1, 
                "beast": 1, "air": 2, "insect": 1, "earth": 0.5, "mind": 1, 
                "melee": 1, "food": 1, "light": 1, "crystal": 0, "metal": 0, 
                "spirit": 0.5, "ice": 1, "dark": 1, "poison": 0.5, "mythic": 1
            },
            "mythic": {
                "basic": 1, "fire": 1, "water": 1, "plant": 1, "spark": 1, 
                "beast": 1, "air": 1, "insect": 1, "earth": 1, "mind": 1, 
                "melee": 1, "food": 1, "light": 1, "crystal": 0.5, "metal": 1, 
                "spirit": 1, "ice": 1, "dark": 1, "poison": 1, "mythic": 2
            }
        };

        const allTypes = Object.keys(defensiveTypeChart);
        
        const typeColors = {
            'Mythic': 'var(--mythic-color)',
            'Fire': 'var(--fire-color)',
            'Water': 'var(--water-color)',
            'Plant': 'var(--plant-color)',
            'Spark': 'var(--spark-color)',
            'Beast': 'var(--beast-color)',
            'Air': 'var(--air-color)',
            'Insect': 'var(--insect-color)',
            'Earth': 'var(--earth-color)',
            'Mind': 'var(--mind-color)',
            'Melee': 'var(--melee-color)',
            'Food': 'var(--food-color)',
            'Light': 'var(--light-color)',
            'Crystal': 'var(--crystal-color)',
            'Metal': 'var(--metal-color)',
            'Spirit': 'var(--spirit-color)',
            'Ice': 'var(--ice-color)',
            'Dark': 'var(--dark-color)',
            'Poison': 'var(--poison-color)',
            'Basic': 'var(--basic-color)'
        };

        const typeIcons = {
            'Mythic': 'logos/mythic.webp',
            'Fire': 'logos/fire.webp',
            'Water': 'logos/water.webp',
            'Plant': 'logos/plant.webp',
            'Spark': 'logos/spark.webp',
            'Beast': 'logos/beast.webp',
            'Air': 'logos/air.webp',
            'Insect': 'logos/bug.webp',
            'Earth': 'logos/earth.webp',
            'Mind': 'logos/mind.webp',
            'Melee': 'logos/melee.webp',
            'Food': 'logos/food.webp',
            'Light': 'logos/light.webp',
            'Crystal': 'logos/crystal.webp',
            'Metal': 'logos/metal.webp',
            'Spirit': 'logos/spirit.webp',
            'Ice': 'logos/ice.webp',
            'Dark': 'logos/dark.webp',
            'Poison': 'logos/poison.webp',
            'Basic': 'logos/basic.webp'
        };

        const traitEffects = {
            "Absorber": { immunity: "primary" },
            "Apex": { removeType: "beast" },
            "Arid": { immunity: "water" },
            "Bright Lights": { immunity: "dark" },
            "Caliginous": { immunity: "light" },
            "Conductor": { immunity: "spark" },
            "Divine Beast": { immunity: "beast" },
            "Filament": { immunity: "spark" },
            "Fire Up": { immunity: "fire" },
            "Fireproof Armor": { damageReduction: { type: "fire", amount: 0.5 } },
            "Blightfrost": { damageReduction: { type: "fire", amount: 0.5 } },
            "Hard Candy": { damageReduction: { type: "fire", amount: 0.5 } },
            "Herbivore": { immunity: "plant" },
            "Karna": { damageReduction: { type: "earth", amount: 0.5 } },
            "Levitate": { immunity: "earth" },
            "Melting Point": { immunity: "ice" },
            "Mushboom": { damageReduction: { type: "air", amount: 0.5 } },
            "Nitelite": { damageReduction: { type: "dark", amount: 0.5 } },
            "Puffball": { damageReduction: { type: "air", amount: 0.5 } },
            "Skyborn": { immunity: "air" },
            "Spiteful": { invertChart: true },
            "Stormwater": { immunity: "water" },
            "Tumble": { damageReduction: { type: "melee", amount: 0.5 } },
            "Water Absorb": { immunity: "water" },
            "Sky Deity": { immunity: ["air", "earth"] },
            "Adipose": { damageReduction: [{ type: "fire", amount: 0.5 }, { type: "ice", amount: 0.5 }] },
            "Floaty": { damageReduction: { type: "air", amount: 0.5 } }
        };

        const traitMoveTypeChanges = {
            "Galvanize": { from: "basic", to: "spark" },
            "Your Meowjesty": { from: "basic", to: "air" },
            "Toxicity": { from: "basic", to: "poison" },
            "Apparition": { from: "basic", to: "spirit" },
            "Luminosity": { from: "dark", to: "light" }
        };

        const specialMoveTypes = {
            "Chemical Breath": {
                "Noxvul": "poison",
                "Exovul": "fire", 
                "Endovul": "ice",
                "Vuliable": "basic"
            },
            "Elemental Claws": {
                "Lacergen-Earth": "earth",
                "Lacergen-Spark": "spark",
                "Lacergen-Fire": "fire",
                "Lacergen-Ice": "ice"
            }
        };

        const doodleDefaultTraits = {
            "Lacergen-Earth": "Absorber",
            "Lacergen-Spark": "Absorber",
            "Lacergen-Fire": "Absorber",
            "Lacergen-Ice": "Absorber",
            "Gyornaw": "Apex",
            "Arthopex": "Apex",
            "Prickles": "Arid",
            "Trithorn": "Adipose",
            "Boblop": "Adipose", 
            "Gigarlic": "Adipose",
            "Caramellow": "Adipose",
            "Groato": "Adipose",
            "Phantern": "Bright Lights",
            "Abyssent": "Bright Lights",
            "Flong": "Caliginous",
            "Mourveil": "Caliginous",
            "Voltenchant": "Conductor",
            "Scorsurge": "Conductor",
            "Vermorph": "Conductor",
            "Metalytra": "Conductor",
            "Voltatoo": "Conductor",
            "Koriyu": "Divine Beast",
            "Jelluminous": "Filament",
            "Meltimaw": "Fire Up",
            "Salaferno": "Fire Up",
            "Exovul": "Fire Up",
            "Bronzoch": "Fire Up",
            "Clangutang": "Fireproof Armor",
            "Aluminja": "Fireproof Armor",
            "Gauntcier": "Fireproof Armor",
            "Endovul": "Blightfrost",
            "Somberock": "Hard Candy",
            "Gowatt": "Herbivore",
            "Springling": "Herbivore",
            "Nyanto": "Herbivore",
            "Goliage": "Herbivore",
            "Infurnius": "Karna",
            "Riptorvent": "Levitate",
            "Spectrowl": "Levitate",
            "Morphiu-C": "Levitate",
            "Morphiu-L": "Levitate",
            "Morphiu-T": "Levitate",
            "Morphiu-O": "Levitate",
            "Daeferno": "Levitate",
            "Serpentsheen": "Levitate",
            "Incandesect": "Levitate",
            "Ignisect": "Levitate",
            "Bubbull-A": "Melting Point",
            "Hypnotl-A": "Mushboom",
            "Lumiline": "Nitelite",
            "Klydaskunk": "Nitelite",
            "Hypnotl": "Puffball",
            "Nimbell": "Skyborn",
            "Morphiu-G": "Skyborn",
            "Theaterror-A": "Spiteful",
            "Moss": "Stormwater",
            "Mold": "Stormwater",
            "Ctholos": "Stormwater",
            "Snorolla": "Tumble",
            "Libelagua": "Water Absorb",
            "Cacmeow": "Water Absorb",
            "Goliage": "Water Absorb",
            "Mantiscald": "Water Absorb",
            "Umaisho": "Water Absorb",
            "Kelpimer": "Water Absorb",
            "Riptorvent-A": "Sky Deity",
            "Aerystal": "Floaty"
        };

        const moveTypeMap = {};
        
        const doodleAttunements = {
            "Mawthra-A": { runestone: "Mawthra Rune", signatureTrait: "Warden" },
            "Thornet-A": { runestone: "Thornet Rune", signatureTrait: "Retaliate" },
            "Voltenchant-A": { runestone: "Voltenchant Rune", signatureTrait: "Downpour" },
            "Theaterror-A": { runestone: "Theaterror Rune", signatureTrait: "Spiteful" },
            "Maskomedy-A": { runestone: "Maskomedy Rune", signatureTrait: "Cardinal Sins" },
            "Mourveil-A": { runestone: "Mourveil Rune", signatureTrait: "The Fungus" },
            "Malotrick-A": { runestone: "Malotrick Rune", signatureTrait: "Gaseous Form" },
            "Tulenna-A": { runestone: "Tulenna Rune", signatureTrait: "Toxicity" },
            "Staligant-A": { runestone: "Staligant Rune" },
            "Corrolizard-A": { runestone: "Corrolizard Rune", signatureTrait: "Decay" },
            "Grufflin-A": { runestone: "Grufflin Rune", signatureTrait: "Analytical" },
            "Skadean-A": { runestone: "Skadean Rune", signatureTrait: "Sea Goddess Disciple" },
            "Partybug-A": { runestone: "Partybug Rune", signatureTrait: "Archmage" },
            "Somberock-A": { runestone: "Somberock Rune", signatureTrait: "Luminosity" },
            "Nyanto-A": { runestone: "Nyanto Rune", signatureTrait: "Your Meowjesty" },
            "Suomous-A": { runestone: "Suomous Rune", signatureTrait: "Jab Cross" },
            "Daeferno-A": { runestone: "Daeferno Rune", signatureTrait: "Revenant" },
            "Vigimante-A": { runestone: "Vigimante Rune", signatureTrait: "Crowd Support" },
            "Groato-A": { runestone: "Groato Rune", signatureTrait: "Extinguisher" },
            "Lumiline-A": { runestone: "Lumiline Rune", signatureTrait: "Crystallization" },
            "Cacmeow-A": { runestone: "Cacmeow Rune", signatureTrait: "Visicous" },
            "Cryotera-A": { runestone: "Cryotera Rune", signatureTrait: "Bypass" },
            "Spectatik-A": { runestone: "Spectatik Rune", signatureTrait: "Speed of Swag" },
            "Bionotic-A": { runestone: "Bionotic Rune", signatureTrait: "Mind Games" },
            "Archopos-A": { runestone: "Archopos Rune", signatureTrait: "Delicate" },
            "Cerebopod-A": { runestone: "Cerebopod Rune", signatureTrait: "Refreshed Resilience" },
            "Hattrix-A": { runestone: "Hattrix Rune", signatureTrait: "Spell Shield" },
            "Cragildae-A": { runestone: "Cragildae Rune", signatureTrait: "Grounded" },
            "Bubbull-A": { runestone: "Bubbul Rune", signatureTrait: "Melting Point" },
            "Tufflaze-A": { runestone: "Tufflaze Rune", signatureTrait: "Annihilation" },
            "Libelagua-A": { runestone: "Libelagua Rune", signatureTrait: "Bogdown" },
            "Snowclowne-A": { signatureItem: "Snowclowne Silly Cone", signatureTrait: "Frostillery" },
            "Jellupy-A": { signatureItem: "Jellupy Whisk", signatureTrait: "Jelly Sync" },
            "Fancyoon-A": { signatureItem: "Fancyoon Boa", signatureTrait: "Foul Welcome" },
            "Hangryphus-A": { signatureItem: "Hangryphus Pie", signatureTrait: "Last Stand" },
            "Exoskelis-A": { signatureItem: "Exoskelis Shard", signatureTrait: "Revival" },
            "Calamander-A": { signatureItem: "Calamander's Candy", signatureTrait: "Hidden Strength" },
            "Umaisho-A": { signatureItem: "Umaisho Matcha", signatureTrait: "Lipid Scale" },
            "Ostigon-A": { signatureItem: "Ostigon Collar", signatureTrait: "Corruption" },
            "Vermorph-A": { signatureItem: "Vermorph Goggles", signatureTrait: "Electrician" },
            "Jinglark-A": { signatureItem: "Jinglark Present", signatureTrait: "Holiday Spirit" },
            "Hypnotl-A": { signatureItem: "Hypnotl Antigen", signatureTrait: "Mushboom" },
            "Riptorvent-A": { signatureItem: "Riptorvent Rune", signatureTrait: "Sky Deity" },
            "Bungo": { signatureTrait: "Split" },
            "Seamknight": { signatureTrait: "Vigor" },
            "Seamstress": { signatureTrait: "Elegance" },
            "Reliconis": { signatureTrait: "Reformation" },
            "Armaratus": { signatureTrait: "Soul Fortification" },
            "Glacigash": { signatureTrait: "Enfeeble" },
            "Lacergen-Earth": { signatureItem: "Earth Data" },
            "Lacergen-Spark": { signatureItem: "Spark Data" },
            "Lacergen-Fire": { signatureItem: "Fire Data" },
            "Lacergen-Ice": { signatureItem: "Ice Data" },
            "Hollihare-A": { signatureItem: "Hollihare Wreath", signatureTrait: "Sugarsick" },
            "Freqrec": { signatureTrait: "Static Startle" },
        };

        // DOODLES ARRAY (unchanged - too long to include here)
        const doodles = [
            // ... (same as before)
            { name: "Aerystal", image: "https://i.ibb.co/9KdDtN1/Aerystal-1.webp", type: "Crystal/Air" },
            // ... (rest of doodles array)
        ];

        // MOVES ARRAYS (unchanged - too long to include here)
        const basicMoves = [ /* ... */ ];
        const mythicMoves = [ /* ... */ ];
        const fireMoves = [ /* ... */ ];
        const waterMoves = [ /* ... */ ];
        const plantMoves = [ /* ... */ ];
        const electricMoves = [ /* ... */ ];
        const beastMoves = [ /* ... */ ];
        const airMoves = [ /* ... */ ];
        const bugMoves = [ /* ... */ ];
        const earthMoves = [ /* ... */ ];
        const mindMoves = [ /* ... */ ];
        const meleeMoves = [ /* ... */ ];
        const foodMoves = [ /* ... */ ];
        const lightMoves = [ /* ... */ ];
        const crystalMoves = [ /* ... */ ];
        const metalMoves = [ /* ... */ ];
        const spiritMoves = [ /* ... */ ];
        const iceMoves = [ /* ... */ ];
        const darkMoves = [ /* ... */ ];
        const poisonMoves = [ /* ... */ ];

        // OTHER ARRAYS (unchanged - too long to include here)
        const helmets = [ /* ... */ ];
        const amulets = [ /* ... */ ];
        const artifacts = [ /* ... */ ];
        const stats = [ /* ... */ ];
        const heldItems = [ /* ... */ ];
        const traits = [ /* ... */ ].concat(["Floaty"]); // Add Floaty to traits list

        const moveGroups = [
            { name: "Basic", moves: basicMoves, type: "Basic" },
            { name: "Mythic", moves: mythicMoves, type: "Mythic" },
            { name: "Fire", moves: fireMoves, type: "Fire" },
            { name: "Water", moves: waterMoves, type: "Water" },
            { name: "Plant", moves: plantMoves, type: "Plant" },
            { name: "Spark", moves: electricMoves, type: "Spark" },
            { name: "Beast", moves: beastMoves, type: "Beast" },
            { name: "Air", moves: airMoves, type: "Air" },
            { name: "Insect", moves: bugMoves, type: "Insect" },
            { name: "Earth", moves: earthMoves, type: "Earth" },
            { name: "Mind", moves: mindMoves, type: "Mind" },
            { name: "Melee", moves: meleeMoves, type: "Melee" },
            { name: "Food", moves: foodMoves, type: "Food" },
            { name: "Light", moves: lightMoves, type: "Light" },
            { name: "Crystal", moves: crystalMoves, type: "Crystal" },
            { name: "Metal", moves: metalMoves, type: "Metal" },
            { name: "Spirit", moves: spiritMoves, type: "Spirit" },
            { name: "Ice", moves: iceMoves, type: "Ice" },
            { name: "Dark", moves: darkMoves, type: "Dark" },
            { name: "Poison", moves: poisonMoves, type: "Poison" }
        ];

        function populateMoveTypeMap() {
            basicMoves.forEach(move => moveTypeMap[move] = 'basic');
            mythicMoves.forEach(move => moveTypeMap[move] = 'mythic');
            fireMoves.forEach(move => moveTypeMap[move] = 'fire');
            waterMoves.forEach(move => moveTypeMap[move] = 'water');
            plantMoves.forEach(move => moveTypeMap[move] = 'plant');
            electricMoves.forEach(move => moveTypeMap[move] = 'spark');
            beastMoves.forEach(move => moveTypeMap[move] = 'beast');
            airMoves.forEach(move => moveTypeMap[move] = 'air');
            bugMoves.forEach(move => moveTypeMap[move] = 'insect');
            earthMoves.forEach(move => moveTypeMap[move] = 'earth');
            mindMoves.forEach(move => moveTypeMap[move] = 'mind');
            meleeMoves.forEach(move => moveTypeMap[move] = 'melee');
            foodMoves.forEach(move => moveTypeMap[move] = 'food');
            lightMoves.forEach(move => moveTypeMap[move] = 'light');
            crystalMoves.forEach(move => moveTypeMap[move] = 'crystal');
            metalMoves.forEach(move => moveTypeMap[move] = 'metal');
            spiritMoves.forEach(move => moveTypeMap[move] = 'spirit');
            iceMoves.forEach(move => moveTypeMap[move] = 'ice');
            darkMoves.forEach(move => moveTypeMap[move] = 'dark');
            poisonMoves.forEach(move => moveTypeMap[move] = 'poison');
        }

        const defensiveTraits = Object.keys(traitEffects);

        const MAX_TEAMS = 5;
        let teams = [];
        let currentTeamIndex = -1;
        let defensiveDoodleCount = 1;
        let matchupInitialized = false;

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', function() {
                    const targetPage = this.getAttribute('data-page');
                    
                    document.querySelectorAll('.nav-button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    document.querySelectorAll('.page').forEach(page => {
                        page.classList.remove('active');
                    });
                    document.getElementById(targetPage).classList.add('active');
                    
                    if (targetPage === 'matchup') {
                        setTimeout(() => {
                            if (!matchupInitialized) {
                                initializeMatchupCalculator();
                                matchupInitialized = true;
                            }
                        }, 100);
                    }
                });
            });

            populateMoveTypeMap();
            initialize();
        });

        function initialize() {
            initializeTeambuilder();
            initializeDefensiveCalculator();
            initializeOffensiveCalculator();
        }

        function initializeTeambuilder() {
            populateDoodleDropdown();
            loadFromStorage();
            setupTeambuilderEventListeners();
            
            if (teams.length === 0) {
                addTeam();
            } else {
                updateTeamSelect();
                if (currentTeamIndex >= 0 && currentTeamIndex < teams.length) {
                    loadTeam(currentTeamIndex);
                } else {
                    currentTeamIndex = 0;
                    loadTeam(currentTeamIndex);
                }
            }
        }

        function populateDoodleDropdown() {
            const doodleOptions = document.getElementById('doodle-options');
            doodleOptions.innerHTML = '';
            
            if (doodles && doodles.length > 0) {
                doodles.forEach(doodle => {
                    const option = document.createElement('div');
                    option.className = 'dropdown-option';
                    option.textContent = doodle.name;
                    option.dataset.value = doodle.name;
                    option.dataset.image = doodle.image;
                    option.dataset.type = doodle.type;
                    
                    option.addEventListener('click', function() {
                        document.getElementById('doodle-header').querySelector('span').textContent = doodle.name;
                        document.getElementById('doodle-list').classList.remove('active');
                        
                        document.querySelectorAll('#doodle-options .dropdown-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');
                    });
                    
                    doodleOptions.appendChild(option);
                });
            }
        }

        function setupTeambuilderEventListeners() {
            document.getElementById('add-team').addEventListener('click', addTeam);
            document.getElementById('delete-team').addEventListener('click', deleteTeam);
            document.getElementById('team-select').addEventListener('change', changeTeam);
            document.getElementById('team-name').addEventListener('change', updateTeamName);
            document.getElementById('add-doodle').addEventListener('click', addDoodleToTeam);
            document.getElementById('copy-code').addEventListener('click', copyTeamCode);
            document.getElementById('import-code').addEventListener('click', importTeamCode);
            document.getElementById('import-text').addEventListener('click', importFromText);
            
            const doodleHeader = document.getElementById('doodle-header');
            const doodleList = document.getElementById('doodle-list');
            const doodleSearch = document.getElementById('doodle-search');
            
            doodleHeader.addEventListener('click', function() {
                doodleList.classList.toggle('active');
                if (doodleList.classList.contains('active')) {
                    doodleSearch.focus();
                }
            });
            
            doodleSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                const options = document.querySelectorAll('#doodle-options .dropdown-option');
                
                const validTypes = Object.keys(typeColors).map(type => type.toLowerCase());
                const isTypeSearch = !searchTerm.includes(' ') && validTypes.includes(searchTerm);
                
                options.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    const doodleType = option.dataset.type.toLowerCase();
                    
                    if (isTypeSearch) {
                        option.style.display = doodleType.includes(searchTerm) ? 'block' : 'none';
                    } else {
                        option.style.display = text.includes(searchTerm) ? 'block' : 'none';
                    }
                });
            });
            
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.custom-dropdown')) {
                    doodleList.classList.remove('active');
                }
            });
        }

        function addTeam() {
            if (teams.length >= MAX_TEAMS) {
                alert(`Maximum of ${MAX_TEAMS} teams reached!`);
                return;
            }

            let teamNumber = 1;
            const teamNames = teams.map(team => team.name);
            while (teamNames.includes(`Team ${teamNumber}`)) {
                teamNumber++;
            }

            const newTeam = {
                name: `Team ${teamNumber}`,
                notes: "",
                doodles: []
            };

            teams.push(newTeam);
            currentTeamIndex = teams.length - 1;
            updateTeamSelect();
            loadTeam(currentTeamIndex);
            saveToStorage();
        }

        function deleteTeam() {
            if (teams.length <= 1) {
                alert("You must have at least one team!");
                return;
            }

            if (currentTeamIndex === -1) return;

            saveCurrentTeamState();
            
            teams.splice(currentTeamIndex, 1);
            
            if (currentTeamIndex >= teams.length) {
                currentTeamIndex = teams.length - 1;
            }

            updateTeamSelect();
            loadTeam(currentTeamIndex);
            saveToStorage();
        }

        function changeTeam() {
            const select = document.getElementById('team-select');
            const newIndex = parseInt(select.value);
            
            if (currentTeamIndex !== -1 && currentTeamIndex !== newIndex) {
                saveCurrentTeamState();
            }
            
            currentTeamIndex = newIndex;
            if (currentTeamIndex >= 0 && currentTeamIndex < teams.length) {
                loadTeam(currentTeamIndex);
            }
        }

        function saveCurrentTeamState() {
            if (currentTeamIndex === -1 || currentTeamIndex >= teams.length) return;
            
            teams[currentTeamIndex].name = document.getElementById('team-name').value || `Team ${currentTeamIndex + 1}`;
            
            const doodleCards = document.querySelectorAll('.doodle-card');
            doodleCards.forEach((card, index) => {
                if (index < teams[currentTeamIndex].doodles.length) {
                    const doodle = teams[currentTeamIndex].doodles[index];
                    
                    // Save moves from custom dropdowns
                    for (let i = 0; i < 4; i++) {
                        const moveHeader = card.querySelector(`.move-dropdown[data-move-index="${i}"] .dropdown-header span:first-child`);
                        if (moveHeader) {
                            const moveText = moveHeader.textContent;
                            if (moveText !== 'Select Move') {
                                // Extract move name from header (remove type icon)
                                const moveName = moveText.replace(/[â–²â–¶â–º]/g, '').trim();
                                doodle.moves[i] = moveName;
                            } else {
                                doodle.moves[i] = "";
                            }
                        }
                    }
                    
                    // Save trait
                    const traitHeader = card.querySelector('.trait-dropdown .dropdown-header span:first-child');
                    if (traitHeader) {
                        doodle.trait = traitHeader.textContent !== 'Select Trait' ? traitHeader.textContent : "";
                    }
                    
                    // Save held item
                    const heldItemHeader = card.querySelector('.held-item-dropdown .dropdown-header span:first-child');
                    if (heldItemHeader) {
                        doodle.heldItem = heldItemHeader.textContent !== 'Held Item' ? heldItemHeader.textContent : "None";
                    }
                    
                    // Save stats
                    const statHeaders = card.querySelectorAll('.stat-dropdown .dropdown-header span:first-child');
                    statHeaders.forEach((header, statIndex) => {
                        if (statIndex < 2) {
                            doodle.stats[statIndex] = header.textContent !== 'Select Stat' ? header.textContent : "";
                        }
                    });
                    
                    // Save equipment
                    const helmetHeader = card.querySelector('.helmet-dropdown .dropdown-header span:first-child');
                    const amuletHeader = card.querySelector('.amulet-dropdown .dropdown-header span:first-child');
                    const artifactHeader = card.querySelector('.artifact-dropdown .dropdown-header span:first-child');
                    
                    if (helmetHeader) {
                        doodle.equipment.helmet = helmetHeader.textContent !== 'Helmet' ? helmetHeader.textContent : "None";
                    }
                    if (amuletHeader) {
                        doodle.equipment.amulet = amuletHeader.textContent !== 'Amulet' ? amuletHeader.textContent : "None";
                    }
                    if (artifactHeader) {
                        doodle.equipment.artifact = artifactHeader.textContent !== 'Artifact' ? artifactHeader.textContent : "None";
                    }
                }
            });
            
            saveToStorage();
        }

        function updateTeamName() {
            if (currentTeamIndex === -1 || currentTeamIndex >= teams.length) return;
            const newName = document.getElementById('team-name').value || `Team ${currentTeamIndex + 1}`;
            teams[currentTeamIndex].name = newName;
            updateTeamSelect();
            saveToStorage();
        }

        function updateTeamSelect() {
            const teamSelect = document.getElementById('team-select');
            teamSelect.innerHTML = '';
            
            teams.forEach((team, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = team.name;
                if (index === currentTeamIndex) {
                    option.selected = true;
                }
                teamSelect.appendChild(option);
            });
        }

        function addDoodleToTeam() {
            if (currentTeamIndex === -1 || currentTeamIndex >= teams.length) {
                alert("Please select or create a team first!");
                return;
            }
            
            if (teams[currentTeamIndex].doodles.length >= 6) {
                alert('Team is full! Maximum 6 doodles allowed.');
                return;
            }
            
            const selectedDoodleName = document.getElementById('doodle-header').querySelector('span').textContent;
            if (selectedDoodleName === 'Select a Doodle') {
                alert('Please select a doodle first!');
                return;
            }
            
            const doodle = doodles.find(d => d.name === selectedDoodleName);
            if (doodle) {
                const baseDoodle = {
                    name: doodle.name,
                    image: doodle.image,
                    type: doodle.type,
                    moves: ["", "", "", ""],
                    trait: "",
                    heldItem: "",
                    stats: ["", ""],
                    equipment: {
                        helmet: "None",
                        amulet: "None",
                        artifact: "None"
                    }
                };
                
                const autoAttune = document.getElementById('auto-attune').checked;
                const attunement = doodleAttunements[doodle.name];
                
                let finalDoodle = {...baseDoodle};
                
                if (autoAttune && attunement) {
                    if (attunement.signatureTrait) {
                        finalDoodle.trait = attunement.signatureTrait;
                    }
                    
                    if (attunement.runestone) {
                        finalDoodle.heldItem = attunement.runestone;
                    } else if (attunement.signatureItem) {
                        finalDoodle.heldItem = attunement.signatureItem;
                    }
                }
                
                teams[currentTeamIndex].doodles.push(finalDoodle);
                renderTeam();
                saveToStorage();
                
                document.getElementById('doodle-header').querySelector('span').textContent = 'Select a Doodle';
                document.querySelectorAll('#doodle-options .dropdown-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
            }
        }

        function removeDoodle(index) {
            if (currentTeamIndex === -1 || currentTeamIndex >= teams.length) return;
            teams[currentTeamIndex].doodles.splice(index, 1);
            renderTeam();
            saveToStorage();
        }

        function getMoveType(moveName, trait = null, doodleName = null) {
            if (!moveName) return null;
            
            if (specialMoveTypes[moveName] && doodleName) {
                const specialType = specialMoveTypes[moveName][doodleName];
                if (specialType) return specialType;
            }
            
            let moveType = moveTypeMap[moveName];
            
            if (trait && traitMoveTypeChanges[trait] && moveType) {
                const typeChange = traitMoveTypeChanges[trait];
                if (moveType === typeChange.from) {
                    moveType = typeChange.to;
                }
            }
            
            return moveType;
        }

        window.updateDoodleData = function(doodleIndex, field, value) {
            if (currentTeamIndex === -1 || currentTeamIndex >= teams.length) return;
            if (field.includes('.')) {
                const parts = field.split('.');
                teams[currentTeamIndex].doodles[doodleIndex][parts[0]][parts[1]] = value;
            } else {
                teams[currentTeamIndex].doodles[doodleIndex][field] = value;
            }
            saveToStorage();
        };

        function renderTeam() {
            if (currentTeamIndex === -1 || currentTeamIndex >= teams.length) return;
            
            const teamDisplay = document.getElementById('team-display');
            teamDisplay.innerHTML = '';
            
            teams[currentTeamIndex].doodles.forEach((doodle, index) => {
                const card = createDoodleCard(doodle, index);
                teamDisplay.appendChild(card);
            });
        }

        function createDoodleCard(doodle, index) {
            const card = document.createElement('div');
            card.className = 'doodle-card';
            card.id = `doodle-card-${index}`;
            card.draggable = true;
            card.dataset.index = index;
            
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('dragenter', handleDragEnter);
            card.addEventListener('dragleave', handleDragLeave);
            card.addEventListener('drop', handleDrop);
            card.addEventListener('dragend', handleDragEnd);
            
            const cardHeader = document.createElement('div');
            cardHeader.className = 'card-header';
            
            const slotInfo = document.createElement('div');
            slotInfo.textContent = `Slot ${index + 1}`;
            slotInfo.style.fontWeight = 'bold';
            slotInfo.style.color = 'var(--header-color)';
            
            const cardButtons = document.createElement('div');
            cardButtons.className = 'card-buttons';
            
            const clearBtn = document.createElement('button');
            clearBtn.className = 'card-btn';
            clearBtn.textContent = 'Clear';
            clearBtn.onclick = () => clearDoodleCard(index);
            
            const exportBtn = document.createElement('button');
            exportBtn.className = 'card-btn';
            exportBtn.textContent = 'Export';
            exportBtn.onclick = () => exportDoodleToText(index);
            
            const attunement = doodleAttunements[doodle.name];
            if (attunement) {
                const attuneBtn = document.createElement('button');
                attuneBtn.className = 'card-btn attune-btn';
                attuneBtn.textContent = 'Attune';
                attuneBtn.onclick = () => applyAttunement(index);
                cardButtons.appendChild(attuneBtn);
            }
            
            cardButtons.appendChild(clearBtn);
            cardButtons.appendChild(exportBtn);
            cardHeader.appendChild(slotInfo);
            cardHeader.appendChild(cardButtons);
            
            const doodleInfo = document.createElement('div');
            doodleInfo.className = 'doodle-sprite-container';
            
            const sprite = document.createElement('div');
            sprite.className = 'doodle-sprite';
            sprite.style.backgroundImage = `url(${doodle.image})`;
            
            const info = document.createElement('div');
            info.className = 'doodle-info';
            
            const name = document.createElement('div');
            name.className = 'doodle-name';
            name.textContent = doodle.name;
            
            if (attunement) {
                const attunedIndicator = document.createElement('span');
                attunedIndicator.className = 'attunement-indicator';
                attunedIndicator.title = 'Has signature attunements';
                name.appendChild(attunedIndicator);
                
                card.classList.add('attuned');
            }
            
            const typeBadges = document.createElement('div');
            typeBadges.className = 'type-badges';
            const types = doodle.type.split('/');
            types.forEach(type => {
                const badge = document.createElement('span');
                badge.className = `type-badge ${type.toLowerCase()}`;
                badge.textContent = type;
                badge.style.backgroundColor = typeColors[type] || typeColors['Basic'];
                
                const icon = document.createElement('span');
                icon.className = 'type-icon';
                icon.style.backgroundImage = `url(${typeIcons[type] || typeIcons['Basic']})`;
                badge.prepend(icon);
                
                typeBadges.appendChild(badge);
            });
            
            info.appendChild(name);
            info.appendChild(typeBadges);
            
            doodleInfo.appendChild(sprite);
            doodleInfo.appendChild(info);
            
            const expandBtn = document.createElement('button');
            expandBtn.className = 'card-btn expand-btn';
            expandBtn.textContent = 'Expand';
            expandBtn.onclick = () => toggleExpandSection(index);
            
            const expandSection = document.createElement('div');
            expandSection.className = 'expand-section';
            expandSection.id = `expand-section-${index}`;
            
            card.appendChild(cardHeader);
            card.appendChild(doodleInfo);
            card.appendChild(expandBtn);
            card.appendChild(expandSection);
            
            setTimeout(() => {
                expandSection.innerHTML = createExpandSectionContent(doodle, index);
                setupCustomDropdowns(index);
            }, 0);
            
            return card;
        }

        function handleDragStart(e) {
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.index);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        }

        function handleDragLeave() {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const toIndex = parseInt(this.dataset.index);
            
            if (fromIndex !== toIndex) {
                const team = teams[currentTeamIndex];
                [team.doodles[fromIndex], team.doodles[toIndex]] = [team.doodles[toIndex], team.doodles[fromIndex]];
                
                renderTeam();
                saveToStorage();
            }
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            document.querySelectorAll('.doodle-card').forEach(card => {
                card.classList.remove('drag-over');
            });
        }

        function createExpandSectionContent(doodle, index) {
            return `
                <div class="section-title">Moves</div>
                <div class="moves-container">
                    ${Array(4).fill().map((_, i) => `
                        <div class="custom-dropdown move-dropdown" data-doodle="${index}" data-move-index="${i}">
                            <div class="dropdown-header move-header">
                                <span>${doodle.moves[i] || "Select Move"}</span>
                                <span>â–¼</span>
                            </div>
                            <div class="dropdown-list move-list">
                                <input type="text" class="dropdown-search move-search" placeholder="Search moves...">
                                <div class="dropdown-options move-options"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="section-title">Trait</div>
                <div class="custom-dropdown trait-dropdown" data-doodle="${index}">
                    <div class="dropdown-header trait-header">
                        <span>${doodle.trait || "Select Trait"}</span>
                        <span>â–¼</span>
                    </div>
                    <div class="dropdown-list trait-list">
                        <input type="text" class="dropdown-search trait-search" placeholder="Search traits...">
                        <div class="dropdown-options trait-options"></div>
                    </div>
                </div>
                
                <div class="section-title">Held Item</div>
                <div class="custom-dropdown held-item-dropdown" data-doodle="${index}">
                    <div class="dropdown-header held-item-header">
                        <span>${doodle.heldItem || "Held Item"}</span>
                        <span>â–¼</span>
                    </div>
                    <div class="dropdown-list held-item-list">
                        <input type="text" class="dropdown-search held-item-search" placeholder="Search held items...">
                        <div class="dropdown-options held-item-options"></div>
                    </div>
                </div>
                
                <div class="section-title">Stats</div>
                <div class="stats-container">
                    ${Array(2).fill().map((_, i) => `
                        <div class="custom-dropdown stat-dropdown" data-doodle="${index}" data-stat-index="${i}">
                            <div class="dropdown-header stat-header">
                                <span>${doodle.stats[i] || "Select Stat"}</span>
                                <span>â–¼</span>
                            </div>
                            <div class="dropdown-list stat-list">
                                <input type="text" class="dropdown-search stat-search" placeholder="Search stats...">
                                <div class="dropdown-options stat-options"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="section-title">Equipment</div>
                <div class="equipment-container">
                    <div class="custom-dropdown helmet-dropdown" data-doodle="${index}">
                        <div class="dropdown-header helmet-header">
                            <span>${doodle.equipment.helmet || "Helmet"}</span>
                            <span>â–¼</span>
                        </div>
                        <div class="dropdown-list helmet-list">
                            <input type="text" class="dropdown-search helmet-search" placeholder="Search helmets...">
                            <div class="dropdown-options helmet-options"></div>
                        </div>
                    </div>
                    <div class="custom-dropdown amulet-dropdown" data-doodle="${index}">
                        <div class="dropdown-header amulet-header">
                            <span>${doodle.equipment.amulet || "Amulet"}</span>
                            <span>â–¼</span>
                        </div>
                        <div class="dropdown-list amulet-list">
                            <input type="text" class="dropdown-search amulet-search" placeholder="Search amulets...">
                            <div class="dropdown-options amulet-options"></div>
                        </div>
                    </div>
                    <div class="custom-dropdown artifact-dropdown" data-doodle="${index}">
                        <div class="dropdown-header artifact-header">
                            <span>${doodle.equipment.artifact || "Artifact"}</span>
                            <span>â–¼</span>
                        </div>
                        <div class="dropdown-list artifact-list">
                            <input type="text" class="dropdown-search artifact-search" placeholder="Search artifacts...">
                            <div class="dropdown-options artifact-options"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function setupCustomDropdowns(index) {
            setupMoveDropdowns(index);
            setupTraitDropdown(index);
            setupHeldItemDropdown(index);
            setupStatDropdowns(index);
            setupEquipmentDropdowns(index);
        }

        function setupMoveDropdowns(doodleIndex) {
            for (let i = 0; i < 4; i++) {
                const dropdown = document.querySelector(`.move-dropdown[data-doodle="${doodleIndex}"][data-move-index="${i}"]`);
                const header = dropdown.querySelector('.move-header');
                const list = dropdown.querySelector('.move-list');
                const search = dropdown.querySelector('.move-search');
                const options = dropdown.querySelector('.move-options');
                
                options.innerHTML = '';
                
                moveGroups.forEach(group => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'move-option-group';
                    
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'move-group-header';
                    groupHeader.textContent = group.name;
                    groupHeader.style.color = typeColors[group.type];
                    groupDiv.appendChild(groupHeader);
                    
                    group.moves.forEach(move => {
                        const option = document.createElement('div');
                        option.className = 'dropdown-option move-option';
                        option.dataset.value = move;
                        
                        const icon = document.createElement('span');
                        icon.className = 'type-icon';
                        icon.style.backgroundImage = `url(${typeIcons[group.type] || typeIcons['Basic']})`;
                        
                        const text = document.createTextNode(move);
                        
                        option.appendChild(icon);
                        option.appendChild(text);
                        
                        option.addEventListener('click', function() {
                            const headerSpan = header.querySelector('span:first-child');
                            headerSpan.innerHTML = '';
                            
                            const selectedIcon = icon.cloneNode(true);
                            headerSpan.appendChild(selectedIcon);
                            headerSpan.appendChild(document.createTextNode(move));
                            
                            list.classList.remove('active');
                            updateDoodleData(doodleIndex, `moves.${i}`, move);
                            
                            options.querySelectorAll('.move-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            this.classList.add('selected');
                        });
                        
                        groupDiv.appendChild(option);
                    });
                    
                    options.appendChild(groupDiv);
                });
                
                // Set initial selected move
                const doodle = teams[currentTeamIndex].doodles[doodleIndex];
                if (doodle.moves[i]) {
                    const moveOption = options.querySelector(`.move-option[data-value="${doodle.moves[i]}"]`);
                    if (moveOption) {
                        moveOption.click();
                    }
                }
                
                header.addEventListener('click', function() {
                    list.classList.toggle('active');
                    if (list.classList.contains('active')) {
                        search.focus();
                    }
                });
                
                search.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const groups = options.querySelectorAll('.move-option-group');
                    
                    groups.forEach(group => {
                        const optionsInGroup = group.querySelectorAll('.move-option');
                        let hasVisible = false;
                        optionsInGroup.forEach(option => {
                            const text = option.textContent.toLowerCase();
                            if (text.includes(searchTerm)) {
                                option.style.display = 'flex';
                                hasVisible = true;
                            } else {
                                option.style.display = 'none';
                            }
                        });
                        group.style.display = hasVisible ? 'block' : 'none';
                    });
                });
            }
        }

        function setupTraitDropdown(doodleIndex) {
            const dropdown = document.querySelector(`.trait-dropdown[data-doodle="${doodleIndex}"]`);
            const header = dropdown.querySelector('.trait-header');
            const list = dropdown.querySelector('.trait-list');
            const search = dropdown.querySelector('.trait-search');
            const options = dropdown.querySelector('.trait-options');
            
            options.innerHTML = '';
            
            traits.forEach(trait => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.textContent = trait;
                option.dataset.value = trait;
                
                option.addEventListener('click', function() {
                    header.querySelector('span:first-child').textContent = trait;
                    list.classList.remove('active');
                    updateDoodleData(doodleIndex, 'trait', trait);
                    
                    options.querySelectorAll('.dropdown-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
                
                options.appendChild(option);
            });
            
            // Set initial selected trait
            const doodle = teams[currentTeamIndex].doodles[doodleIndex];
            if (doodle.trait) {
                const traitOption = options.querySelector(`.dropdown-option[data-value="${doodle.trait}"]`);
                if (traitOption) {
                    traitOption.click();
                }
            }
            
            header.addEventListener('click', function() {
                list.classList.toggle('active');
                if (list.classList.contains('active')) {
                    search.focus();
                }
            });
            
            search.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const optionsList = options.querySelectorAll('.dropdown-option');
                
                optionsList.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    option.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
            });
        }

        function setupHeldItemDropdown(doodleIndex) {
            const dropdown = document.querySelector(`.held-item-dropdown[data-doodle="${doodleIndex}"]`);
            const header = dropdown.querySelector('.held-item-header');
            const list = dropdown.querySelector('.held-item-list');
            const search = dropdown.querySelector('.held-item-search');
            const options = dropdown.querySelector('.held-item-options');
            
            options.innerHTML = '';
            
            heldItems.forEach(item => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.textContent = item;
                option.dataset.value = item;
                
                option.addEventListener('click', function() {
                    header.querySelector('span:first-child').textContent = item;
                    list.classList.remove('active');
                    updateDoodleData(doodleIndex, 'heldItem', item);
                    
                    options.querySelectorAll('.dropdown-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
                
                options.appendChild(option);
            });
            
            // Set initial selected held item
            const doodle = teams[currentTeamIndex].doodles[doodleIndex];
            if (doodle.heldItem) {
                const itemOption = options.querySelector(`.dropdown-option[data-value="${doodle.heldItem}"]`);
                if (itemOption) {
                    itemOption.click();
                }
            }
            
            header.addEventListener('click', function() {
                list.classList.toggle('active');
                if (list.classList.contains('active')) {
                    search.focus();
                }
            });
            
            search.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const optionsList = options.querySelectorAll('.dropdown-option');
                
                optionsList.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    option.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
            });
        }

        function setupStatDropdowns(doodleIndex) {
            for (let i = 0; i < 2; i++) {
                const dropdown = document.querySelector(`.stat-dropdown[data-doodle="${doodleIndex}"][data-stat-index="${i}"]`);
                const header = dropdown.querySelector('.stat-header');
                const list = dropdown.querySelector('.stat-list');
                const search = dropdown.querySelector('.stat-search');
                const options = dropdown.querySelector('.stat-options');
                
                options.innerHTML = '';
                
                stats.forEach(stat => {
                    const option = document.createElement('div');
                    option.className = 'dropdown-option';
                    option.textContent = stat;
                    option.dataset.value = stat;
                    
                    option.addEventListener('click', function() {
                        header.querySelector('span:first-child').textContent = stat;
                        list.classList.remove('active');
                        updateDoodleData(doodleIndex, `stats.${i}`, stat);
                        
                        options.querySelectorAll('.dropdown-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');
                    });
                    
                    options.appendChild(option);
                });
                
                // Set initial selected stat
                const doodle = teams[currentTeamIndex].doodles[doodleIndex];
                if (doodle.stats[i]) {
                    const statOption = options.querySelector(`.dropdown-option[data-value="${doodle.stats[i]}"]`);
                    if (statOption) {
                        statOption.click();
                    }
                }
                
                header.addEventListener('click', function() {
                    list.classList.toggle('active');
                    if (list.classList.contains('active')) {
                        search.focus();
                    }
                });
                
                search.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const optionsList = options.querySelectorAll('.dropdown-option');
                    
                    optionsList.forEach(option => {
                        const text = option.textContent.toLowerCase();
                        option.style.display = text.includes(searchTerm) ? 'block' : 'none';
                    });
                });
            }
        }

        function setupEquipmentDropdowns(doodleIndex) {
            // Helmet dropdown
            const helmetDropdown = document.querySelector(`.helmet-dropdown[data-doodle="${doodleIndex}"]`);
            const helmetHeader = helmetDropdown.querySelector('.helmet-header');
            const helmetList = helmetDropdown.querySelector('.helmet-list');
            const helmetSearch = helmetDropdown.querySelector('.helmet-search');
            const helmetOptions = helmetDropdown.querySelector('.helmet-options');
            
            helmetOptions.innerHTML = '';
            
            helmets.forEach(helmet => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.textContent = helmet;
                option.dataset.value = helmet;
                
                option.addEventListener('click', function() {
                    helmetHeader.querySelector('span:first-child').textContent = helmet;
                    helmetList.classList.remove('active');
                    updateDoodleData(doodleIndex, 'equipment.helmet', helmet);
                    
                    helmetOptions.querySelectorAll('.dropdown-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
                
                helmetOptions.appendChild(option);
            });
            
            // Amulet dropdown
            const amuletDropdown = document.querySelector(`.amulet-dropdown[data-doodle="${doodleIndex}"]`);
            const amuletHeader = amuletDropdown.querySelector('.amulet-header');
            const amuletList = amuletDropdown.querySelector('.amulet-list');
            const amuletSearch = amuletDropdown.querySelector('.amulet-search');
            const amuletOptions = amuletDropdown.querySelector('.amulet-options');
            
            amuletOptions.innerHTML = '';
            
            amulets.forEach(amulet => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.textContent = amulet;
                option.dataset.value = amulet;
                
                option.addEventListener('click', function() {
                    amuletHeader.querySelector('span:first-child').textContent = amulet;
                    amuletList.classList.remove('active');
                    updateDoodleData(doodleIndex, 'equipment.amulet', amulet);
                    
                    amuletOptions.querySelectorAll('.dropdown-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
                
                amuletOptions.appendChild(option);
            });
            
            // Artifact dropdown
            const artifactDropdown = document.querySelector(`.artifact-dropdown[data-doodle="${doodleIndex}"]`);
            const artifactHeader = artifactDropdown.querySelector('.artifact-header');
            const artifactList = artifactDropdown.querySelector('.artifact-list');
            const artifactSearch = artifactDropdown.querySelector('.artifact-search');
            const artifactOptions = artifactDropdown.querySelector('.artifact-options');
            
            artifactOptions.innerHTML = '';
            
            artifacts.forEach(artifact => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.textContent = artifact;
                option.dataset.value = artifact;
                
                option.addEventListener('click', function() {
                    artifactHeader.querySelector('span:first-child').textContent = artifact;
                    artifactList.classList.remove('active');
                    updateDoodleData(doodleIndex, 'equipment.artifact', artifact);
                    
                    artifactOptions.querySelectorAll('.dropdown-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
                
                artifactOptions.appendChild(option);
            });
            
            // Set initial equipment values
            const doodle = teams[currentTeamIndex].doodles[doodleIndex];
            
            // Helmet
            if (doodle.equipment.helmet) {
                const helmetOption = helmetOptions.querySelector(`.dropdown-option[data-value="${doodle.equipment.helmet}"]`);
                if (helmetOption) {
                    helmetOption.click();
                }
            }
            
            // Amulet
            if (doodle.equipment.amulet) {
                const amuletOption = amuletOptions.querySelector(`.dropdown-option[data-value="${doodle.equipment.amulet}"]`);
                if (amuletOption) {
                    amuletOption.click();
                }
            }
            
            // Artifact
            if (doodle.equipment.artifact) {
                const artifactOption = artifactOptions.querySelector(`.dropdown-option[data-value="${doodle.equipment.artifact}"]`);
                if (artifactOption) {
                    artifactOption.click();
                }
            }
            
            // Add event listeners for headers and search
            [helmetHeader, amuletHeader, artifactHeader].forEach((header, idx) => {
                const list = [helmetList, amuletList, artifactList][idx];
                const search = [helmetSearch, amuletSearch, artifactSearch][idx];
                
                header.addEventListener('click', function() {
                    list.classList.toggle('active');
                    if (list.classList.contains('active')) {
                        search.focus();
                    }
                });
            });
            
            [helmetSearch, amuletSearch, artifactSearch].forEach((search, idx) => {
                const options = [helmetOptions, amuletOptions, artifactOptions][idx];
                
                search.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const optionsList = options.querySelectorAll('.dropdown-option');
                    
                    optionsList.forEach(option => {
                        const text = option.textContent.toLowerCase();
                        option.style.display = text.includes(searchTerm) ? 'block' : 'none';
                    });
                });
            });
        }

        function toggleExpandSection(index) {
            const expandSection = document.getElementById(`expand-section-${index}`);
            const expandBtn = document.querySelector(`#doodle-card-${index} .expand-btn`);
            
            if (expandSection.classList.contains('active')) {
                expandSection.classList.remove('active');
                expandBtn.textContent = 'Expand';
            } else {
                expandSection.classList.add('active');
                expandBtn.textContent = 'Hide';
            }
        }

        function clearDoodleCard(index) {
            if (currentTeamIndex === -1 || currentTeamIndex >= teams.length) return;
            teams[currentTeamIndex].doodles.splice(index, 1);
            renderTeam();
            saveToStorage();
        }

        function applyAttunement(index) {
            if (currentTeamIndex === -1 || currentTeamIndex >= teams.length) return;
            
            const doodle = teams[currentTeamIndex].doodles[index];
            const attunement = doodleAttunements[doodle.name];
            
            if (!attunement) {
                alert("No attunement data found for this doodle!");
                return;
            }
            
            if (attunement.signatureTrait) {
                doodle.trait = attunement.signatureTrait;
            }
            
            if (attunement.runestone) {
                doodle.heldItem = attunement.runestone;
            } else if (attunement.signatureItem) {
                doodle.heldItem = attunement.signatureItem;
            }
            
            renderTeam();
            saveToStorage();
            
            alert(`Attuned ${doodle.name} with signature items!`);
        }

        function exportDoodleToText(index) {
            if (currentTeamIndex === -1 || currentTeamIndex >= teams.length) return;
            
            const doodle = teams[currentTeamIndex].doodles[index];
            if (!doodle) return;
            
            let text = `${doodle.name} @ ${doodle.heldItem || "None"} - ${doodle.trait || "No Trait"} - ${doodle.equipment.helmet}/${doodle.equipment.amulet}/${doodle.equipment.artifact}`;
            
            const statsText = doodle.stats.filter(s => s).join(", ");
            if (statsText) {
                text += ` - ${statsText}`;
            }
            
            const moves = doodle.moves.filter(m => m).join("/");
            if (moves) {
                text += ` - ${moves}`;
            }
            
            navigator.clipboard.writeText(text)
                .then(() => alert("Doodle text copied to clipboard!"))
                .catch(() => {
                    const textarea = document.createElement("textarea");
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand("copy");
                    document.body.removeChild(textarea);
                    alert("Doodle text copied!");
                });
        }

        function copyTeamCode() {
            if (currentTeamIndex === -1 || currentTeamIndex >= teams.length) return;
            
            try {
                const team = teams[currentTeamIndex];
                let teamText = `Team: ${team.name}\n\n`;
                
                team.doodles.forEach((doodle, index) => {
                    teamText += `Slot ${index + 1}:\n`;
                    
                    teamText += `${doodle.name} @ ${doodle.heldItem || "None"} - ${doodle.trait || "No Trait"} - ${doodle.equipment.helmet}/${doodle.equipment.amulet}/${doodle.equipment.artifact}`;
                    
                    const statsText = doodle.stats.filter(s => s).join(", ");
                    if (statsText) {
                        teamText += ` - ${statsText}`;
                    }
                    
                    const moves = doodle.moves.filter(m => m).join("/");
                    if (moves) {
                        teamText += ` - ${moves}`;
                    }
                    
                    teamText += '\n\n';
                });
                
                navigator.clipboard.writeText(teamText)
                    .then(() => alert("Team code copied to clipboard!"))
                    .catch(() => {
                        const textarea = document.createElement("textarea");
                        textarea.value = teamText;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand("copy");
                        document.body.removeChild(textarea);
                        alert("Team code copied!");
                    });
            } catch (error) {
                console.error("Copy failed:", error);
                alert("Error generating team code. Check console for details.");
            }
        }

        function importTeamCode() {
            const teamCode = prompt("Paste team code:");
            if (!teamCode) return;

            try {
                if (currentTeamIndex !== -1 && currentTeamIndex < teams.length) {
                    saveCurrentTeamState();
                }
                
                const lines = teamCode.split('\n');
                const teamNameMatch = lines[0].match(/Team: (.+)/);
                const teamName = teamNameMatch ? teamNameMatch[1] : "Imported Team";
                
                const importedDoodles = [];
                let currentDoodle = null;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (line.startsWith('Slot')) {
                        if (currentDoodle) {
                            importedDoodles.push(currentDoodle);
                        }
                        currentDoodle = {
                            name: "",
                            image: "",
                            type: "",
                            moves: ["", "", "", ""],
                            trait: "",
                            heldItem: "",
                            stats: ["", ""],
                            equipment: {
                                helmet: "None",
                                amulet: "None",
                                artifact: "None"
                            }
                        };
                    } else if (line.includes(' @ ')) {
                        if (currentDoodle) {
                            const parts = line.split(' - ');
                            
                            const doodleItemPart = parts[0];
                            const doodleItemParts = doodleItemPart.split(' @ ');
                            currentDoodle.name = doodleItemParts[0].trim();
                            currentDoodle.heldItem = doodleItemParts.length > 1 ? doodleItemParts[1].trim() : "None";
                            
                            if (parts.length > 1) {
                                currentDoodle.trait = parts[1].trim();
                            }
                            
                            if (parts.length > 2) {
                                const equipmentParts = parts[2].split('/');
                                if (equipmentParts.length >= 1) currentDoodle.equipment.helmet = equipmentParts[0].trim() || "None";
                                if (equipmentParts.length >= 2) currentDoodle.equipment.amulet = equipmentParts[1].trim() || "None";
                                if (equipmentParts.length >= 3) currentDoodle.equipment.artifact = equipmentParts[2].trim() || "None";
                            }
                            
                            if (parts.length > 3 && parts[3].includes('%')) {
                                const statsParts = parts[3].split(',').map(s => s.trim());
                                for (let j = 0; j < Math.min(statsParts.length, 2); j++) {
                                    currentDoodle.stats[j] = statsParts[j];
                                }
                            }
                            
                            let movesIndex = 4;
                            if (parts.length > 3 && !parts[3].includes('%')) {
                                movesIndex = 3;
                            }
                            if (parts.length > movesIndex) {
                                const moves = parts[movesIndex].split('/').map(m => m.trim());
                                for (let j = 0; j < Math.min(moves.length, 4); j++) {
                                    currentDoodle.moves[j] = moves[j];
                                }
                            }
                            
                            const doodleData = doodles.find(d => d.name === currentDoodle.name);
                            if (doodleData) {
                                currentDoodle.image = doodleData.image;
                                currentDoodle.type = doodleData.type;
                            }
                        }
                    }
                }
                
                if (currentDoodle) {
                    importedDoodles.push(currentDoodle);
                }
                
                const teamData = {
                    name: teamName,
                    notes: "",
                    doodles: importedDoodles
                };
                
                if (teams.length < MAX_TEAMS) {
                    teams.push(teamData);
                    currentTeamIndex = teams.length - 1;
                    updateTeamSelect();
                    loadTeam(currentTeamIndex);
                    saveToStorage();
                    alert("Team imported successfully as a new team!");
                } else {
                    if (confirm("No space for new team. Replace current team?")) {
                        teams[currentTeamIndex] = teamData;
                        loadTeam(currentTeamIndex);
                        saveToStorage();
                        alert("Team imported successfully (replaced current team)!");
                    }
                }
            } catch (error) {
                console.error("Import failed:", error);
                alert("Invalid team code! Please check and try again.");
            }
        }

        function importFromText() {
            const text = prompt("Paste Doodle text (format: Doodle @ Item - Trait - Helmet/Amulet/Artifact - +10%, +10% - Move/Move/Move/Move)");
            if (!text) return;

            try {
                const parts = text.split(' - ');
                
                const doodleItemPart = parts[0];
                const doodleItemParts = doodleItemPart.split(' @ ');
                const doodleName = doodleItemParts[0].trim();
                const heldItem = doodleItemParts.length > 1 ? doodleItemParts[1].trim() : "None";
                
                const trait = parts.length > 1 ? parts[1].trim() : "";
                
                let equipment = { helmet: "None", amulet: "None", artifact: "None" };
                if (parts.length > 2) {
                    const equipmentParts = parts[2].split('/');
                    if (equipmentParts.length >= 1) equipment.helmet = equipmentParts[0].trim() || "None";
                    if (equipmentParts.length >= 2) equipment.amulet = equipmentParts[1].trim() || "None";
                    if (equipmentParts.length >= 3) equipment.artifact = equipmentParts[2].trim() || "None";
                }
                
                let stats = ["", ""];
                if (parts.length > 3 && parts[3].includes('%')) {
                    const statsParts = parts[3].split(',').map(s => s.trim());
                    for (let j = 0; j < Math.min(statsParts.length, 2); j++) {
                        stats[j] = statsParts[j];
                    }
                }
                
                let moves = ["", "", "", ""];
                let movesIndex = 4;
                if (parts.length > 3 && !parts[3].includes('%')) {
                    movesIndex = 3;
                }
                if (parts.length > movesIndex) {
                    const movesParts = parts[movesIndex].split('/').map(m => m.trim());
                    for (let j = 0; j < Math.min(movesParts.length, 4); j++) {
                        moves[j] = movesParts[j];
                    }
                }
                
                if (currentTeamIndex === -1 || teams[currentTeamIndex].doodles.length >= 6) {
                    alert("Team is full! Clear a slot first.");
                    return;
                }
                
                const doodle = doodles.find(d => d.name === doodleName);
                if (!doodle) {
                    alert("Doodle not found in database!");
                    return;
                }
                
                teams[currentTeamIndex].doodles.push({
                    name: doodle.name,
                    image: doodle.image,
                    type: doodle.type,
                    moves: moves,
                    trait: trait,
                    heldItem: heldItem,
                    stats: stats,
                    equipment: equipment
                });
                
                renderTeam();
                saveToStorage();
                alert("Doodle imported successfully!");
            } catch (error) {
                console.error("Import failed:", error);
                alert("Error importing doodle. Please check the format and try again.");
            }
        }

        function loadTeam(index) {
            if (index < 0 || index >= teams.length) return;
            
            const team = teams[index];
            document.getElementById('team-name').value = team.name;
            renderTeam();
        }

        function loadFromStorage() {
            const savedTeams = localStorage.getItem('doodleTeams');
            const savedIndex = localStorage.getItem('currentTeamIndex');
            
            if (savedTeams) {
                teams = JSON.parse(savedTeams);
                currentTeamIndex = savedIndex ? parseInt(savedIndex) : 0;
                return true;
            }
            return false;
        }

        function saveToStorage() {
            localStorage.setItem('doodleTeams', JSON.stringify(teams));
            localStorage.setItem('currentTeamIndex', currentTeamIndex);
        }

        function initializeDefensiveCalculator() {
            document.getElementById('add-defensive').addEventListener('click', addDefensiveDoodle);
            document.getElementById('save-defensive').addEventListener('click', saveDefensiveTeam);
            document.getElementById('load-defensive').addEventListener('click', loadDefensiveTeam);
            document.getElementById('load-from-teambuilder').addEventListener('click', loadDefensiveFromTeambuilder);
            
            createDefensiveDoodleBox();
        }

        function createDefensiveDoodleBox() {
            const container = document.getElementById('defensive-container');
            const box = document.createElement('div');
            box.className = 'calculator-box';
            box.dataset.index = defensiveDoodleCount;
            
            const header = document.createElement('div');
            header.className = 'calculator-header';
            
            const title = document.createElement('h3');
            title.textContent = `Doodle ${defensiveDoodleCount}`;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-calc';
            removeBtn.textContent = 'Ã—';
            removeBtn.onclick = function() {
                container.removeChild(box);
                updateDefensiveSummary();
            };
            
            header.appendChild(title);
            header.appendChild(removeBtn);
            
            box.innerHTML = `
                <div class="type-select-container">
                    <select class="type-select primary-type" data-doodle="${defensiveDoodleCount}">
                        <option value="">Primary Type</option>
                        ${allTypes.map(type => `<option value="${type}">${type.charAt(0).toUpperCase() + type.slice(1)}</option>`).join('')}
                    </select>
                    <select class="type-select secondary-type" data-doodle="${defensiveDoodleCount}">
                        <option value="">Secondary Type</option>
                        ${allTypes.map(type => `<option value="${type}">${type.charAt(0).toUpperCase() + type.slice(1)}</option>`).join('')}
                    </select>
                    <select class="type-select trait" data-doodle="${defensiveDoodleCount}">
                        <option value="">Trait</option>
                        ${defensiveTraits.map(trait => `<option value="${trait}">${trait}</option>`).join('')}
                    </select>
                </div>
                
                <div class="result-title">Weaknesses:</div>
                <div class="result-list weaknesses" data-doodle="${defensiveDoodleCount}"><span class="none">None</span></div>
                
                <div class="result-title">Resistances:</div>
                <div class="result-list resistances" data-doodle="${defensiveDoodleCount}"><span class="none">None</span></div>
                
                <div class="result-title">Immunities:</div>
                <div class="result-list immunities" data-doodle="${defensiveDoodleCount}"><span class="none">None</span></div>
            `;
            
            box.prepend(header);
            container.appendChild(box);
            defensiveDoodleCount++;
            
            box.querySelectorAll('.type-select').forEach(select => {
                select.addEventListener('change', updateDefensiveCoverage);
            });
        }

        function addDefensiveDoodle() {
            const container = document.getElementById('defensive-container');
            if (container.children.length < 6) {
                createDefensiveDoodleBox();
            } else {
                alert('Maximum of 6 doodles reached!');
            }
        }

        function updateDefensiveCoverage() {
            const doodleIndex = this.getAttribute('data-doodle');
            const box = document.querySelector(`.calculator-box[data-index="${doodleIndex}"]`);
            
            const primaryType = box.querySelector(`.primary-type[data-doodle="${doodleIndex}"]`).value;
            const secondaryType = box.querySelector(`.secondary-type[data-doodle="${doodleIndex}"]`).value;
            const trait = box.querySelector(`.trait[data-doodle="${doodleIndex}"]`).value;

            if (!primaryType) {
                box.querySelector(`.weaknesses[data-doodle="${doodleIndex}"]`).innerHTML = '<span class="none">None</span>';
                box.querySelector(`.resistances[data-doodle="${doodleIndex}"]`).innerHTML = '<span class="none">None</span>';
                box.querySelector(`.immunities[data-doodle="${doodleIndex}"]`).innerHTML = '<span class="none">None</span>';
                updateDefensiveSummary();
                return;
            }

            const weaknesses = calculateDefensiveWeaknesses(primaryType, secondaryType, trait);
            const resistances = calculateDefensiveResistances(primaryType, secondaryType, trait);
            const immunities = calculateDefensiveImmunities(primaryType, secondaryType, trait);

            updateDefensiveResultList(`.weaknesses[data-doodle="${doodleIndex}"]`, weaknesses, 'weakness');
            updateDefensiveResultList(`.resistances[data-doodle="${doodleIndex}"]`, resistances, 'resist');
            updateDefensiveResultList(`.immunities[data-doodle="${doodleIndex}"]`, immunities);

            updateDefensiveSummary();
        }

        function applyTraitEffects(primary, secondary, trait, attackingType, effectiveness) {
            if (!trait || !traitEffects[trait]) return effectiveness;

            const effect = traitEffects[trait];
            
            if (effect.immunity) {
                if (effect.immunity === "primary" && primary === attackingType) {
                    return 0;
                } else if (effect.immunity === attackingType) {
                    return 0;
                } else if (Array.isArray(effect.immunity) && effect.immunity.includes(attackingType)) {
                    return 0;
                }
            }
            
            if (effect.removeType && (primary === effect.removeType || secondary === effect.removeType)) {
                let newEffectiveness = 1;
                if (primary !== effect.removeType) {
                    newEffectiveness *= defensiveTypeChart[primary][attackingType];
                }
                if (secondary && secondary !== effect.removeType) {
                    newEffectiveness *= defensiveTypeChart[secondary][attackingType];
                }
                effectiveness = newEffectiveness;
            }
            
            if (effect.damageReduction && effect.damageReduction.type && effect.damageReduction.type === attackingType) {
                effectiveness *= (1 - effect.damageReduction.amount);
            }
            
            if (effect.damageReduction && Array.isArray(effect.damageReduction)) {
                effect.damageReduction.forEach(reduction => {
                    if (reduction.type === attackingType) {
                        effectiveness *= (1 - reduction.amount);
                    }
                });
            }
            
            if (effect.invertChart) {
                if (effectiveness === 4) effectiveness = 0.25;
                else if (effectiveness === 2) effectiveness = 0.5;
                else if (effectiveness === 0.5) effectiveness = 2;
                else if (effectiveness === 0.25) effectiveness = 4;
            }
            
            return effectiveness;
        }

        function calculateDefensiveWeaknesses(primary, secondary, trait) {
            const results = {};

            allTypes.forEach(attackingType => {
                const primaryEffect = defensiveTypeChart[primary][attackingType];
                const secondaryEffect = secondary ? defensiveTypeChart[secondary][attackingType] : 1;
                let combinedEffect = primaryEffect * secondaryEffect;

                combinedEffect = applyTraitEffects(primary, secondary, trait, attackingType, combinedEffect);

                if (combinedEffect > 1) {
                    if (combinedEffect >= 3.5) { 
                        results[attackingType] = 'weak-4x';
                    } else if (combinedEffect > 1.5) {
                        results[attackingType] = 'weak-2x';
                    } else if (combinedEffect > 1.1) {
                        results[attackingType] = 'weak-075x';
                    }
                }
            });

            return results;
        }

        function calculateDefensiveResistances(primary, secondary, trait) {
            const results = {};

            allTypes.forEach(attackingType => {
                const primaryEffect = defensiveTypeChart[primary][attackingType];
                const secondaryEffect = secondary ? defensiveTypeChart[secondary][attackingType] : 1;
                let combinedEffect = primaryEffect * secondaryEffect;

                combinedEffect = applyTraitEffects(primary, secondary, trait, attackingType, combinedEffect);

                if (combinedEffect < 1 && combinedEffect > 0) {
                    if (combinedEffect <= 0.26) { 
                        results[attackingType] = 'resist-025x';
                    } else if (combinedEffect < 0.9) {
                        results[attackingType] = 'resist-05x';
                    }
                }
            });

            return results;
        }

        function calculateDefensiveImmunities(primary, secondary, trait) {
            const results = {};

            allTypes.forEach(attackingType => {
                const primaryEffect = defensiveTypeChart[primary][attackingType];
                const secondaryEffect = secondary ? defensiveTypeChart[secondary][attackingType] : 1;
                let combinedEffect = primaryEffect * secondaryEffect;

                combinedEffect = applyTraitEffects(primary, secondary, trait, attackingType, combinedEffect);

                if (Math.abs(combinedEffect) < 0.1) { 
                    results[attackingType] = 'immune';
                }
            });

            return results;
        }

        function updateDefensiveResultList(selector, typeEffects, effectType = '') {
            const element = document.querySelector(selector);

            if (!element) return;
            
            if (Object.keys(typeEffects).length === 0) {
                element.innerHTML = '<span class="none">None</span>';
                return;
            }

            element.innerHTML = '';

            const typesArray = Object.entries(typeEffects)
                .sort((a, b) => {
                    if (a[1] !== b[1]) {
                        return a[1].localeCompare(b[1]);
                    }
                    return a[0].localeCompare(b[0]);
                });

            typesArray.forEach(([type, effect]) => {
                let badgeText = type.charAt(0).toUpperCase() + type.slice(1);
                if (effect === 'weak-4x') badgeText += ' (4Ã—)';
                else if (effect === 'weak-2x') badgeText += ' (2Ã—)';
                else if (effect === 'weak-075x') badgeText += ' (1.5Ã—)';
                else if (effect === 'resist-025x') badgeText += ' (Â¼Ã—)';
                else if (effect === 'resist-05x') badgeText += ' (Â½Ã—)';

                const badge = document.createElement('span');
                badge.className = `calc-type-badge ${type} ${effect}`;
                badge.style.backgroundColor = typeColors[type.charAt(0).toUpperCase() + type.slice(1)] || typeColors['basic'];
                
                const icon = document.createElement('span');
                icon.className = 'type-icon';
                icon.style.backgroundImage = `url(${typeIcons[type.charAt(0).toUpperCase() + type.slice(1)] || typeIcons['basic']})`;
                badge.appendChild(icon);
                
                const textNode = document.createTextNode(badgeText);
                badge.appendChild(textNode);
                
                element.appendChild(badge);
            });
        }

        function updateDefensiveSummary() {
            const allWeaknesses = {};
            const allResistances = {};
            const allImmunities = new Set();

            document.querySelectorAll('#defensive-container .calculator-box').forEach((box) => {
                const primary = box.querySelector('.primary-type')?.value;
                const secondary = box.querySelector('.secondary-type')?.value;
                const trait = box.querySelector('.trait')?.value;

                if (primary) {
                    const weaknesses = calculateDefensiveWeaknesses(primary, secondary, trait);
                    Object.entries(weaknesses).forEach(([type, effect]) => {
                        if (!allWeaknesses[type]) allWeaknesses[type] = { count: 0, maxEffect: effect };
                        allWeaknesses[type].count++;
                        if (effect === 'weak-4x') allWeaknesses[type].maxEffect = 'weak-4x';
                        else if (allWeaknesses[type].maxEffect !== 'weak-4x' && effect === 'weak-2x') {
                            allWeaknesses[type].maxEffect = 'weak-2x';
                        }
                        else if (allWeaknesses[type].maxEffect !== 'weak-4x' && 
                                 allWeaknesses[type].maxEffect !== 'weak-2x' && 
                                 effect === 'weak-075x') {
                            allWeaknesses[type].maxEffect = 'weak-075x';
                        }
                    });

                    const resistances = calculateDefensiveResistances(primary, secondary, trait);
                    Object.entries(resistances).forEach(([type, effect]) => {
                        if (!allResistances[type]) allResistances[type] = { count: 0, maxEffect: effect };
                        allResistances[type].count++;
                        if (effect === 'resist-025x') allResistances[type].maxEffect = 'resist-025x';
                        else if (allResistances[type].maxEffect !== 'resist-025x' && effect === 'resist-05x') {
                            allResistances[type].maxEffect = 'resist-05x';
                        }
                    });

                    const immunities = calculateDefensiveImmunities(primary, secondary, trait);
                    Object.keys(immunities).forEach(type => {
                        allImmunities.add(type);
                    });
                }
            });

            updateDefensiveTeamResultList('#team-weaknesses', allWeaknesses, 'weakness');
            updateDefensiveTeamResultList('#team-resistances', allResistances, 'resist');
            updateDefensiveTeamResultList('#team-immunities', allImmunities);

            const noResistances = allTypes.filter(type => {
                return !allResistances[type] && !allImmunities.has(type);
            });
            updateDefensiveTeamResultList('#team-no-resistances', noResistances);
        }

        function updateDefensiveTeamResultList(selector, typeData, effectType = '') {
            const element = document.querySelector(selector);

            if ((effectType === 'weakness' || effectType === 'resist') ? 
                Object.keys(typeData).length === 0 : typeData.size === 0) {
                element.innerHTML = '<span class="none">None</span>';
                return;
            }

            element.innerHTML = '';

            let typesArray;
            if (effectType === 'weakness' || effectType === 'resist') {
                typesArray = Object.entries(typeData)
                    .map(([type, data]) => ({
                        type,
                        count: typeof data === 'object' ? data.count : 0,
                        effect: typeof data === 'object' ? data.maxEffect : data
                    }))
                    .sort((a, b) => {
                        if (b.count !== a.count) return b.count - a.count;
                        if (b.effect !== a.effect) return b.effect.localeCompare(a.effect);
                        return a.type.localeCompare(b.type);
                    });
            } else {
                typesArray = Array.isArray(typeData) ? 
                    typeData.sort((a, b) => a.localeCompare(b)) : 
                    Array.from(typeData).sort((a, b) => a.localeCompare(b));
            }

            typesArray.forEach(type => {
                let typeName = typeof type === 'object' ? type.type : type;
                let effect = typeof type === 'object' ? type.effect : '';
                let count = typeof type === 'object' ? type.count : 0;

                let badgeText = typeName.charAt(0).toUpperCase() + typeName.slice(1);
                if (effectType === 'weakness' || effectType === 'resist') {
                    if (count > 0) {
                        badgeText += ` (${count})`;
                    }
                    if (effect === 'weak-4x') badgeText += ' 4Ã—';
                    else if (effect === 'weak-2x') badgeText += ' 2Ã—';
                    else if (effect === 'weak-075x') badgeText += ' 1.5Ã—';
                    else if (effect === 'resist-025x') badgeText += ' Â¼Ã—';
                    else if (effect === 'resist-05x') badgeText += ' Â½Ã—';
                }

                const badge = document.createElement('span');
                badge.className = `calc-type-badge ${typeName} ${effect}`;
                badge.style.backgroundColor = typeColors[typeName.charAt(0).toUpperCase() + typeName.slice(1)] || typeColors['basic'];
                
                const icon = document.createElement('span');
                icon.className = 'type-icon';
                icon.style.backgroundImage = `url(${typeIcons[typeName.charAt(0).toUpperCase() + typeName.slice(1)] || typeIcons['basic']})`;
                badge.appendChild(icon);
                
                const textNode = document.createTextNode(badgeText);
                badge.appendChild(textNode);
                
                element.appendChild(badge);
            });
        }

        function saveDefensiveTeam() {
            const teamData = {
                doodles: []
            };

            document.querySelectorAll('#defensive-container .calculator-box').forEach((box, index) => {
                const doodleIndex = box.dataset.index;
                const doodleData = { index: doodleIndex };
                
                doodleData.primaryType = box.querySelector(`.primary-type[data-doodle="${doodleIndex}"]`).value;
                doodleData.secondaryType = box.querySelector(`.secondary-type[data-doodle="${doodleIndex}"]`).value;
                doodleData.trait = box.querySelector(`.trait[data-doodle="${doodleIndex}"]`).value;
                
                teamData.doodles.push(doodleData);
            });

            localStorage.setItem('defensiveTeam', JSON.stringify(teamData));
            alert('Defensive team saved successfully!');
        }

        function loadDefensiveTeam() {
            const savedTeam = localStorage.getItem('defensiveTeam');
            if (!savedTeam) {
                alert('No saved defensive team found!');
                return;
            }

            const teamData = JSON.parse(savedTeam);
            loadDefensiveDoodles(teamData);
        }

        function loadDefensiveFromTeambuilder() {
            if (teams.length === 0 || currentTeamIndex === -1) {
                alert('No team found in teambuilder!');
                return;
            }

            const team = teams[currentTeamIndex];
            const teamData = {
                doodles: []
            };

            team.doodles.forEach(doodle => {
                const types = doodle.type.split('/');
                const doodleData = {
                    primaryType: types[0].toLowerCase(),
                    secondaryType: types[1] ? types[1].toLowerCase() : "",
                    trait: doodle.trait
                };
                teamData.doodles.push(doodleData);
            });

            loadDefensiveDoodles(teamData);
            alert('Team loaded from teambuilder!');
        }

        function loadDefensiveDoodles(teamData) {
            const container = document.getElementById('defensive-container');
            container.innerHTML = '';
            defensiveDoodleCount = 1;
            
            teamData.doodles.forEach((doodleData, index) => {
                createDefensiveDoodleBox();
                const box = document.querySelector(`#defensive-container .calculator-box[data-index="${defensiveDoodleCount - 1}"]`);
                
                if (doodleData.primaryType) {
                    box.querySelector(`.primary-type[data-doodle="${defensiveDoodleCount - 1}"]`).value = doodleData.primaryType;
                }
                if (doodleData.secondaryType) {
                    box.querySelector(`.secondary-type[data-doodle="${defensiveDoodleCount - 1}"]`).value = doodleData.secondaryType;
                }
                if (doodleData.trait) {
                    box.querySelector(`.trait[data-doodle="${defensiveDoodleCount - 1}"]`).value = doodleData.trait;
                }
                
                if (box.querySelector('.primary-type')) {
                    box.querySelector('.primary-type').dispatchEvent(new Event('change'));
                }
            });
            
            updateDefensiveSummary();
            alert('Defensive team loaded successfully!');
        }

        function initializeOffensiveCalculator() {
            populateOffensiveTypeDropdowns();
            setupOffensiveEventListeners();
        }

        function populateOffensiveTypeDropdowns() {
            const typeSelects = [
                document.getElementById('type-1'),
                document.getElementById('type-2'),
                document.getElementById('type-3'),
                document.getElementById('type-4')
            ];

            typeSelects.forEach(select => {
                select.innerHTML = '<option value="">Select Type</option>';
                
                allTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                    select.appendChild(option);
                });
            });
        }

        function setupOffensiveEventListeners() {
            document.getElementById('calculate-coverage').addEventListener('click', calculateOffensiveCoverage);
            document.getElementById('reset-coverage').addEventListener('click', resetOffensiveCoverage);
        }

        function calculateOffensiveCoverage() {
            const selectedTypes = [
                document.getElementById('type-1').value,
                document.getElementById('type-2').value,
                document.getElementById('type-3').value,
                document.getElementById('type-4').value
            ].filter(type => type !== "");

            const includeTraits = document.getElementById('include-traits').checked;
            
            const results = {
                superEffective: [],
                normalEffective: [],
                notVeryEffective: [],
                noEffect: []
            };

            doodles.forEach(doodle => {
                let maxEffectiveness = 0;
                
                selectedTypes.forEach(offensiveType => {
                    const effectiveness = calculateOffensiveEffectiveness(offensiveType, doodle, includeTraits);
                    if (effectiveness > maxEffectiveness) {
                        maxEffectiveness = effectiveness;
                    }
                });

                if (selectedTypes.length === 0) {
                    maxEffectiveness = 1;
                }

                if (maxEffectiveness > 1) {
                    results.superEffective.push(doodle);
                } else if (maxEffectiveness === 1) {
                    results.normalEffective.push(doodle);
                } else if (maxEffectiveness > 0) {
                    results.notVeryEffective.push(doodle);
                } else {
                    results.noEffect.push(doodle);
                }
            });

            displayOffensiveResults(results);
        }

        function calculateOffensiveEffectiveness(offensiveType, doodle, includeTraits = false) {
            const defendingTypes = doodle.type.split('/');
            let effectiveness = 1;
            
            defendingTypes.forEach(defendingType => {
                const normalizedDefendingType = defendingType.toLowerCase();
                if (offensiveTypeChart[offensiveType] && offensiveTypeChart[offensiveType][normalizedDefendingType] !== undefined) {
                    effectiveness *= offensiveTypeChart[offensiveType][normalizedDefendingType];
                }
            });
            
            if (includeTraits) {
                const defaultTrait = doodleDefaultTraits[doodle.name];
                if (defaultTrait && traitEffects[defaultTrait]) {
                    const primary = defendingTypes[0].toLowerCase();
                    const secondary = defendingTypes[1] ? defendingTypes[1].toLowerCase() : null;
                    effectiveness = applyTraitEffects(primary, secondary, defaultTrait, offensiveType, effectiveness);
                }
            }
            
            return effectiveness;
        }

        function displayOffensiveResults(results) {
            displayOffensiveResultList('super-effective', results.superEffective);
            displayOffensiveResultList('normal-effective', results.normalEffective);
            displayOffensiveResultList('not-very-effective', results.notVeryEffective);
            displayOffensiveResultList('no-effect', results.noEffect);
        }

        function displayOffensiveResultList(elementId, doodles) {
            const element = document.getElementById(elementId);
            element.innerHTML = '';

            if (doodles.length === 0) {
                element.innerHTML = '<span class="none">None</span>';
                return;
            }

            doodles.forEach(doodle => {
                const doodleElement = document.createElement('div');
                doodleElement.className = 'offensive-doodle-result';
                
                const sprite = document.createElement('div');
                sprite.className = 'doodle-sprite';
                sprite.style.backgroundImage = `url(${doodle.image})`;
                
                const info = document.createElement('div');
                info.className = 'doodle-info';
                
                const name = document.createElement('div');
                name.className = 'doodle-name';
                name.textContent = doodle.name;
                
                const typeBadges = document.createElement('div');
                typeBadges.className = 'type-badges';
                const types = doodle.type.split('/');
                types.forEach(type => {
                    const badge = document.createElement('span');
                    badge.className = `type-badge ${type.toLowerCase()}`;
                    badge.textContent = type;
                    badge.style.backgroundColor = typeColors[type] || typeColors['Basic'];
                    
                    const icon = document.createElement('span');
                    icon.className = 'type-icon';
                    icon.style.backgroundImage = `url(${typeIcons[type] || typeIcons['Basic']})`;
                    badge.prepend(icon);
                    
                    typeBadges.appendChild(badge);
                });
                
                info.appendChild(name);
                info.appendChild(typeBadges);
                
                doodleElement.appendChild(sprite);
                doodleElement.appendChild(info);
                
                element.appendChild(doodleElement);
            });
        }

        function resetOffensiveCoverage() {
            document.getElementById('type-1').value = '';
            document.getElementById('type-2').value = '';
            document.getElementById('type-3').value = '';
            document.getElementById('type-4').value = '';
            
            document.getElementById('super-effective').innerHTML = '<span class="none">None</span>';
            document.getElementById('normal-effective').innerHTML = '<span class="none">None</span>';
            document.getElementById('not-very-effective').innerHTML = '<span class="none">None</span>';
            document.getElementById('no-effect').innerHTML = '<span class="none">None</span>';
        }

        function initializeMatchupCalculator() {
            createMatchupDoodleSelectors();
            setupMatchupEventListeners();
        }

        function createMatchupDoodleSelectors() {
            const container = document.getElementById('matchup-doodles');
            container.innerHTML = '';
            
            for (let i = 1; i <= 4; i++) {
                const selectorDiv = document.createElement('div');
                selectorDiv.className = 'matchup-doodle-select';
                selectorDiv.innerHTML = `
                    <div class="matchup-dropdown-header" data-index="${i}">
                        <span>Select Doodle ${i}</span>
                        <span>â–¼</span>
                    </div>
                    <div class="matchup-dropdown-list" data-index="${i}">
                        <input type="text" class="matchup-dropdown-search" data-index="${i}" placeholder="Search doodles...">
                        <div class="matchup-options" data-index="${i}"></div>
                    </div>
                `;
                container.appendChild(selectorDiv);
            }
            
            populateMatchupDropdowns();
            setupMatchupDropdownEvents();
        }

        function populateMatchupDropdowns() {
            doodles.forEach(doodle => {
                for (let i = 1; i <= 4; i++) {
                    const optionsContainer = document.querySelector(`.matchup-options[data-index="${i}"]`);
                    const option = document.createElement('div');
                    option.className = 'matchup-option';
                    option.dataset.value = doodle.name;
                    option.dataset.type = doodle.type;
                    option.dataset.image = doodle.image;
                    
                    const sprite = document.createElement('div');
                    sprite.className = 'mini-sprite';
                    sprite.style.backgroundImage = `url(${doodle.image})`;
                    
                    const text = document.createElement('span');
                    text.textContent = doodle.name;
                    
                    option.appendChild(sprite);
                    option.appendChild(text);
                    
                    option.addEventListener('click', function() {
                        const header = document.querySelector(`.matchup-dropdown-header[data-index="${i}"] span:first-child`);
                        header.textContent = doodle.name;
                        
                        const dropdown = document.querySelector(`.matchup-dropdown-list[data-index="${i}"]`);
                        dropdown.classList.remove('active');
                        
                        const allOptions = optionsContainer.querySelectorAll('.matchup-option');
                        allOptions.forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                    });
                    
                    optionsContainer.appendChild(option);
                }
            });
        }

        function setupMatchupDropdownEvents() {
            document.querySelectorAll('.matchup-dropdown-header').forEach(header => {
                header.addEventListener('click', function() {
                    const index = this.dataset.index;
                    const dropdown = document.querySelector(`.matchup-dropdown-list[data-index="${index}"]`);
                    dropdown.classList.toggle('active');
                    if (dropdown.classList.contains('active')) {
                        const searchInput = dropdown.querySelector('.matchup-dropdown-search');
                        searchInput.focus();
                    }
                });
            });
            
            document.querySelectorAll('.matchup-dropdown-search').forEach(search => {
                search.addEventListener('input', function() {
                    const index = this.dataset.index;
                    const searchTerm = this.value.toLowerCase();
                    const options = document.querySelectorAll(`.matchup-options[data-index="${index}"] .matchup-option`);
                    
                    options.forEach(option => {
                        const text = option.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            option.style.display = 'flex';
                        } else {
                            option.style.display = 'none';
                        }
                    });
                });
            });
            
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.matchup-doodle-select')) {
                    document.querySelectorAll('.matchup-dropdown-list').forEach(dropdown => {
                        dropdown.classList.remove('active');
                    });
                }
            });
        }

        function setupMatchupEventListeners() {
            document.getElementById('calculate-matchup').addEventListener('click', calculateMatchup);
            document.getElementById('clear-matchup').addEventListener('click', clearMatchup);
        }

        function getSelectedMatchupDoodles() {
            const selectedDoodles = [];
            
            for (let i = 1; i <= 4; i++) {
                const header = document.querySelector(`.matchup-dropdown-header[data-index="${i}"] span:first-child`);
                const doodleName = header.textContent;
                
                if (doodleName && !doodleName.startsWith('Select Doodle')) {
                    const doodle = doodles.find(d => d.name === doodleName);
                    if (doodle) {
                        selectedDoodles.push(doodle);
                    }
                }
            }
            
            return selectedDoodles;
        }

        function calculateMatchup() {
            const selectedDoodles = getSelectedMatchupDoodles();
            
            if (selectedDoodles.length === 0) {
                alert('Please select at least one doodle!');
                return;
            }
            
            const coverageResults = [];
            
            doodles.forEach(attackingDoodle => {
                if (selectedDoodles.some(d => d.name === attackingDoodle.name)) {
                    return;
                }
                
                const attackingTypes = attackingDoodle.type.split('/');
                let bestCoverage = 0;
                let effectiveTypes = [];
                
                // Check each defending doodle
                selectedDoodles.forEach(defendingDoodle => {
                    let isCovered = false;
                    const defendingTypes = defendingDoodle.type.split('/');
                    
                    // Check each attacking type against each defending type
                    attackingTypes.forEach(type => {
                        const effectiveness = calculateTypeEffectiveness(type, defendingTypes);
                        if (effectiveness > 1) {
                            isCovered = true;
                            if (!effectiveTypes.includes(type)) {
                                effectiveTypes.push(type);
                            }
                        }
                    });
                    
                    if (isCovered) {
                        bestCoverage++;
                    }
                });
                
                if (bestCoverage > 0) {
                    coverageResults.push({
                        doodle: attackingDoodle,
                        coverageScore: bestCoverage,
                        effectiveTypes: effectiveTypes,
                        coveragePercent: (bestCoverage / selectedDoodles.length) * 100
                    });
                }
            });
            
            coverageResults.sort((a, b) => {
                if (b.coverageScore !== a.coverageScore) {
                    return b.coverageScore - a.coverageScore;
                }
                return a.doodle.name.localeCompare(b.doodle.name);
            });
            
            displayMatchupResults(coverageResults, selectedDoodles.length);
        }

        function calculateTypeEffectiveness(attackingType, defendingTypes) {
            const normalizedAttackingType = attackingType.toLowerCase();
            let effectiveness = 1;
            
            defendingTypes.forEach(defendingType => {
                const normalizedDefendingType = defendingType.toLowerCase();
                if (offensiveTypeChart[normalizedAttackingType] && 
                    offensiveTypeChart[normalizedAttackingType][normalizedDefendingType] !== undefined) {
                    effectiveness *= offensiveTypeChart[normalizedAttackingType][normalizedDefendingType];
                }
            });
            
            return effectiveness;
        }

        function displayMatchupResults(results, totalSelected) {
            const bestCoverageList = document.getElementById('best-coverage-list');
            const allCoverageList = document.getElementById('all-coverage-list');
            const foundCount = document.getElementById('found-count');
            const bestCoverage = document.getElementById('best-coverage');
            
            foundCount.textContent = results.length;
            
            if (results.length === 0) {
                bestCoverage.textContent = '0 types';
                bestCoverageList.innerHTML = '<span class="none">No doodles found that hit all selected doodles super effectively</span>';
                allCoverageList.innerHTML = '<span class="none">No coverage doodles found</span>';
                return;
            }
            
            const maxCoverage = results[0].coverageScore;
            bestCoverage.textContent = `${maxCoverage}/${totalSelected} (${Math.round((maxCoverage/totalSelected)*100)}%)`;
            
            const bestCoverageDoodles = results.filter(r => r.coverageScore === maxCoverage);
            const otherCoverageDoodles = results.filter(r => r.coverageScore < maxCoverage);
            
            if (bestCoverageDoodles.length === 0) {
                bestCoverageList.innerHTML = '<span class="none">No perfect coverage doodles found</span>';
            } else {
                bestCoverageList.innerHTML = '';
                bestCoverageDoodles.forEach(result => {
                    bestCoverageList.appendChild(createMatchupResultItem(result));
                });
            }
            
            if (otherCoverageDoodles.length === 0) {
                allCoverageList.innerHTML = '<span class="none">No other coverage doodles found</span>';
            } else {
                allCoverageList.innerHTML = '';
                otherCoverageDoodles.forEach(result => {
                    allCoverageList.appendChild(createMatchupResultItem(result));
                });
            }
        }

        function createMatchupResultItem(result) {
            const item = document.createElement('div');
            item.className = 'matchup-result-item';
            
            const sprite = document.createElement('div');
            sprite.className = 'doodle-sprite';
            sprite.style.backgroundImage = `url(${result.doodle.image})`;
            
            const info = document.createElement('div');
            info.className = 'doodle-info';
            
            const name = document.createElement('div');
            name.className = 'doodle-name';
            name.textContent = result.doodle.name;
            
            const typeBadges = document.createElement('div');
            typeBadges.className = 'type-badges';
            const types = result.doodle.type.split('/');
            types.forEach(type => {
                const badge = document.createElement('span');
                badge.className = `type-badge ${type.toLowerCase()}`;
                badge.textContent = type;
                badge.style.backgroundColor = typeColors[type] || typeColors['Basic'];
                
                const icon = document.createElement('span');
                icon.className = 'type-icon';
                icon.style.backgroundImage = `url(${typeIcons[type] || typeIcons['Basic']})`;
                badge.prepend(icon);
                
                typeBadges.appendChild(badge);
            });
            
            const coverageInfo = document.createElement('div');
            coverageInfo.style.marginTop = '8px';
            coverageInfo.style.fontSize = '12px';
            coverageInfo.style.color = result.coverageScore === getSelectedMatchupDoodles().length ? '#4CAF50' : '#FFA726';
            coverageInfo.innerHTML = `
                <strong>Coverage:</strong> ${result.coverageScore}/${getSelectedMatchupDoodles().length} (${Math.round(result.coveragePercent)}%)<br>
                <strong>Effective Types:</strong> ${result.effectiveTypes.map(t => t.charAt(0).toUpperCase() + t.slice(1)).join(', ')}
            `;
            
            info.appendChild(name);
            info.appendChild(typeBadges);
            info.appendChild(coverageInfo);
            
            item.appendChild(sprite);
            item.appendChild(info);
            
            return item;
        }

        function clearMatchup() {
            for (let i = 1; i <= 4; i++) {
                const header = document.querySelector(`.matchup-dropdown-header[data-index="${i}"] span:first-child`);
                header.textContent = `Select Doodle ${i}`;
                
                const options = document.querySelectorAll(`.matchup-options[data-index="${i}"] .matchup-option`);
                options.forEach(opt => opt.classList.remove('selected'));
                
                const search = document.querySelector(`.matchup-dropdown-search[data-index="${i}"]`);
                if (search) search.value = '';
                
                const dropdown = document.querySelector(`.matchup-dropdown-list[data-index="${i}"]`);
                if (dropdown) dropdown.classList.remove('active');
            }
            
            document.getElementById('found-count').textContent = '0';
            document.getElementById('best-coverage').textContent = '0 types';
            document.getElementById('best-coverage-list').innerHTML = '<span class="none">Select doodles and click "Find Coverage"</span>';
            document.getElementById('all-coverage-list').innerHTML = '<span class="none">Select doodles and click "Find Coverage"</span>';
        }
    </script>
</body>
</html>
